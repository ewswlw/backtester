{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [],
   "source": [
    "import warnings\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "from pathlib import Path\n",
    "import os\n",
    "import vectorbt as vbt\n",
    "import io\n",
    "import sys\n",
    "from contextlib import redirect_stdout\n",
    "from datetime import datetime\n",
    "import math\n",
    "import plotly.graph_objects as go\n",
    "from plotly.subplots import make_subplots\n",
    "\n",
    "import warnings\n",
    "warnings.filterwarnings('ignore')\n",
    "\n",
    "# Add project root to path\n",
    "project_root = Path().absolute().parent\n",
    "sys.path.append(str(project_root))\n",
    "\n",
    "# Import utils with different aliases\n",
    "from src.utils import csv_exporter as csv_utils\n",
    "from src.utils import validation as val_utils\n",
    "from src.utils import transformations as trans_utils\n",
    "from src.utils import data_merger as merge_utils\n",
    "from src.utils import config_validator as config_utils\n",
    "from src.utils import metrics as metric_utils\n",
    "from src.core.bloomberg_fetcher import fetch_bloomberg_data\n",
    "from src.utils.transformations import get_ohlc\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Calculating changes...\n",
      "\n",
      "Running verification...\n",
      "Running verification checks...\n",
      "\n",
      "1. Random Date Samples:\n",
      "================================================================================\n",
      "\n",
      "Date: 2007-10-04\n",
      "Previous Quarter End: 2007-09-30\n",
      "Previous Year End: 2006-12-31\n",
      "\n",
      "TSX Values:\n",
      "Current: 14125.11\n",
      "Prev Quarter End: 14098.89\n",
      "Prev Year End: 12908.39\n",
      "QTD% (Manual): 0.19%\n",
      "QTD% (Calculated): 0.19%\n",
      "YTD% (Manual): 9.43%\n",
      "YTD% (Calculated): 9.43%\n",
      "\n",
      "Date: 2010-02-01\n",
      "Previous Quarter End: 2009-12-31\n",
      "Previous Year End: 2009-12-31\n",
      "\n",
      "TSX Values:\n",
      "Current: 11317.55\n",
      "Prev Quarter End: 11746.11\n",
      "Prev Year End: 11746.11\n",
      "QTD% (Manual): -3.65%\n",
      "QTD% (Calculated): -3.65%\n",
      "YTD% (Manual): -3.65%\n",
      "YTD% (Calculated): -3.65%\n",
      "\n",
      "Date: 2014-03-20\n",
      "Previous Quarter End: 2013-12-31\n",
      "Previous Year End: 2013-12-31\n",
      "\n",
      "TSX Values:\n",
      "Current: 14361.83\n",
      "Prev Quarter End: 13621.55\n",
      "Prev Year End: 13621.55\n",
      "QTD% (Manual): 5.43%\n",
      "QTD% (Calculated): 5.43%\n",
      "YTD% (Manual): 5.43%\n",
      "YTD% (Calculated): 5.43%\n",
      "\n",
      "Date: 2014-08-11\n",
      "Previous Quarter End: 2014-06-30\n",
      "Previous Year End: 2013-12-31\n",
      "\n",
      "TSX Values:\n",
      "Current: 15261.64\n",
      "Prev Quarter End: 15146.01\n",
      "Prev Year End: 13621.55\n",
      "QTD% (Manual): 0.76%\n",
      "QTD% (Calculated): 0.76%\n",
      "YTD% (Manual): 12.04%\n",
      "YTD% (Calculated): 12.04%\n",
      "\n",
      "Date: 2022-05-23\n",
      "Previous Quarter End: 2022-03-31\n",
      "Previous Year End: 2021-12-31\n",
      "\n",
      "TSX Values:\n",
      "Current: 20197.61\n",
      "Prev Quarter End: 21890.16\n",
      "Prev Year End: 21222.84\n",
      "QTD% (Manual): -7.73%\n",
      "QTD% (Calculated): -7.73%\n",
      "YTD% (Manual): -4.83%\n",
      "YTD% (Calculated): -4.83%\n",
      "\n",
      "2. Quarter/Year Boundary Checks:\n",
      "================================================================================\n",
      "\n",
      "First day of quarter example:\n",
      "Date: 2014-04-01 00:00:00\n",
      "TSX QTD%: 0.32%\n",
      "\n",
      "Final Dataset Info:\n",
      "================================================================================\n",
      "<class 'pandas.core.frame.DataFrame'>\n",
      "DatetimeIndex: 5493 entries, 2003-09-24 to 2025-01-31\n",
      "Data columns (total 40 columns):\n",
      " #   Column               Non-Null Count  Dtype  \n",
      "---  ------               --------------  -----  \n",
      " 0   cad_oas              5493 non-null   float64\n",
      " 1   us_hy_oas            5493 non-null   float64\n",
      " 2   us_ig_oas            5493 non-null   float64\n",
      " 3   tsx                  5493 non-null   float64\n",
      " 4   vix                  5493 non-null   float64\n",
      " 5   cad_ig_er_index      5493 non-null   float64\n",
      " 6   us_hy_er_index       5493 non-null   float64\n",
      " 7   us_ig_er_index       5493 non-null   float64\n",
      " 8   cad_oas_3m           5493 non-null   float64\n",
      " 9   cad_oas_1yr          5493 non-null   float64\n",
      " 10  us_hy_oas_3m         5493 non-null   float64\n",
      " 11  us_hy_oas_1yr        5493 non-null   float64\n",
      " 12  us_ig_oas_3m         5493 non-null   float64\n",
      " 13  us_ig_oas_1yr        5493 non-null   float64\n",
      " 14  tsx_3m               5493 non-null   float64\n",
      " 15  tsx_1yr              5493 non-null   float64\n",
      " 16  vix_3m               5493 non-null   float64\n",
      " 17  vix_1yr              5493 non-null   float64\n",
      " 18  cad_ig_er_index_3m   5493 non-null   float64\n",
      " 19  cad_ig_er_index_1yr  5493 non-null   float64\n",
      " 20  us_hy_er_index_3m    5493 non-null   float64\n",
      " 21  us_hy_er_index_1yr   5493 non-null   float64\n",
      " 22  us_ig_er_index_3m    5493 non-null   float64\n",
      " 23  us_ig_er_index_1yr   5493 non-null   float64\n",
      " 24  cad_oas_qtd          5493 non-null   float64\n",
      " 25  us_hy_oas_qtd        5493 non-null   float64\n",
      " 26  us_ig_oas_qtd        5493 non-null   float64\n",
      " 27  tsx_qtd              5493 non-null   float64\n",
      " 28  vix_qtd              5493 non-null   float64\n",
      " 29  cad_ig_er_index_qtd  5493 non-null   float64\n",
      " 30  us_hy_er_index_qtd   5493 non-null   float64\n",
      " 31  us_ig_er_index_qtd   5493 non-null   float64\n",
      " 32  cad_oas_ytd          5493 non-null   float64\n",
      " 33  us_hy_oas_ytd        5493 non-null   float64\n",
      " 34  us_ig_oas_ytd        5493 non-null   float64\n",
      " 35  tsx_ytd              5493 non-null   float64\n",
      " 36  vix_ytd              5493 non-null   float64\n",
      " 37  cad_ig_er_index_ytd  5493 non-null   float64\n",
      " 38  us_hy_er_index_ytd   5493 non-null   float64\n",
      " 39  us_ig_er_index_ytd   5493 non-null   float64\n",
      "dtypes: float64(40)\n",
      "memory usage: 1.8 MB\n"
     ]
    }
   ],
   "source": [
    "# Getting all the data \n",
    "mapping = {\n",
    "    ('I05510CA Index', 'INDEX_OAS_TSY_BP'): 'cad_oas',\n",
    "    ('LF98TRUU Index', 'INDEX_OAS_TSY_BP'): 'us_hy_oas',\n",
    "    ('LUACTRUU Index', 'INDEX_OAS_TSY_BP'): 'us_ig_oas',\n",
    "    ('SPTSX Index', 'PX_LAST'): 'tsx',\n",
    "    ('VIX Index', 'PX_LAST'): 'vix',\n",
    "}\n",
    "\n",
    "# Calculate dates\n",
    "end_date = datetime.now().strftime('%Y-%m-%d')\n",
    "start_date ='2002-01-01'\n",
    "\n",
    "# Fetch the data\n",
    "df = fetch_bloomberg_data(\n",
    "    mapping=mapping,\n",
    "    start_date=start_date,\n",
    "    end_date=end_date,\n",
    "    periodicity='D',\n",
    "    align_start=True\n",
    ").dropna()\n",
    "\n",
    "# Getting all the er_ytd data \n",
    "mapping1 = {\n",
    "    ('I05510CA Index', 'INDEX_EXCESS_RETURN_YTD'): 'cad_ig_er',\n",
    "    ('LF98TRUU Index', 'INDEX_EXCESS_RETURN_YTD'): 'us_hy_er',\n",
    "    ('LUACTRUU Index', 'INDEX_EXCESS_RETURN_YTD'): 'us_ig_er',\n",
    "}\n",
    "\n",
    "# Fetch the er_ytd_data\n",
    "df1 = fetch_bloomberg_data(\n",
    "    mapping=mapping1,\n",
    "    start_date=start_date,\n",
    "    end_date=end_date,\n",
    "    periodicity='D',\n",
    "    align_start=True\n",
    ").dropna()\n",
    "\n",
    "# Convert er_ytd data to an index\n",
    "df2 = trans_utils.convert_er_ytd_to_index(df1[['cad_ig_er','us_hy_er','us_ig_er']])\n",
    "final_df = merge_utils.merge_dfs(df, df2, fill='ffill', start_date_align='yes')\n",
    "\n",
    "# Handle bad data point for cad_oas on Nov 15 2005\n",
    "bad_date = '2005-11-15'\n",
    "if bad_date in final_df.index:\n",
    "    final_df.loc[bad_date, 'cad_oas'] = final_df.loc[final_df.index < bad_date, 'cad_oas'].iloc[-1]\n",
    "\n",
    "def calculate_qtd_changes(df):\n",
    "    df_copy = df.copy()\n",
    "    df_copy.index = pd.to_datetime(df_copy.index)\n",
    "    \n",
    "    qtd_changes = pd.DataFrame(index=df_copy.index)\n",
    "    for col in df_copy.columns:\n",
    "        changes = []\n",
    "        for date in df_copy.index:\n",
    "            # Get the start of the current quarter\n",
    "            current_quarter_start = date.to_period('Q').start_time\n",
    "            \n",
    "            # Get the end of previous quarter (last day of previous quarter)\n",
    "            prev_quarter_end = current_quarter_start - pd.Timedelta(days=1)\n",
    "            \n",
    "            # Get the value at the end of previous quarter\n",
    "            mask = df_copy.index <= prev_quarter_end\n",
    "            if not mask.any():\n",
    "                changes.append(np.nan)\n",
    "                continue\n",
    "            \n",
    "            prev_quarter_value = df_copy[col][mask].iloc[-1]\n",
    "            current_value = df_copy[col][date]\n",
    "            \n",
    "            # Calculate change\n",
    "            pct_change = (current_value / prev_quarter_value - 1) * 100\n",
    "            changes.append(pct_change)\n",
    "            \n",
    "        qtd_changes[f'{col}_qtd'] = changes\n",
    "    return qtd_changes\n",
    "\n",
    "def calculate_ytd_changes(df):\n",
    "    df_copy = df.copy()\n",
    "    df_copy.index = pd.to_datetime(df_copy.index)\n",
    "    \n",
    "    ytd_changes = pd.DataFrame(index=df_copy.index)\n",
    "    for col in df_copy.columns:\n",
    "        changes = []\n",
    "        for date in df_copy.index:\n",
    "            # Get the start of the current year\n",
    "            current_year_start = date.to_period('Y').start_time\n",
    "            \n",
    "            # Get the end of previous year (last day of previous year)\n",
    "            prev_year_end = current_year_start - pd.Timedelta(days=1)\n",
    "            \n",
    "            # Get the value at the end of previous year\n",
    "            mask = df_copy.index <= prev_year_end\n",
    "            if not mask.any():\n",
    "                changes.append(np.nan)\n",
    "                continue\n",
    "            \n",
    "            prev_year_value = df_copy[col][mask].iloc[-1]\n",
    "            current_value = df_copy[col][date]\n",
    "            \n",
    "            # Calculate change\n",
    "            pct_change = (current_value / prev_year_value - 1) * 100\n",
    "            changes.append(pct_change)\n",
    "            \n",
    "        ytd_changes[f'{col}_ytd'] = changes\n",
    "    return ytd_changes\n",
    "\n",
    "def add_all_changes(df):\n",
    "    # Make a copy to avoid modifying original\n",
    "    result_df = df.copy()\n",
    "    result_df.index = pd.to_datetime(result_df.index)\n",
    "    \n",
    "    # Calculate regular percentage changes (3M and 1YR)\n",
    "    for col in df.columns:\n",
    "        # 3-month change (63 trading days approximation)\n",
    "        result_df[f'{col}_3m'] = df[col].pct_change(periods=63) * 100\n",
    "        # 1-year change (252 trading days approximation)\n",
    "        result_df[f'{col}_1yr'] = df[col].pct_change(periods=252) * 100\n",
    "    \n",
    "    # Add QTD and YTD changes\n",
    "    qtd_df = calculate_qtd_changes(df)\n",
    "    ytd_df = calculate_ytd_changes(df)\n",
    "    \n",
    "    # Combine all changes\n",
    "    for col in qtd_df.columns:\n",
    "        result_df[col] = qtd_df[col]\n",
    "    for col in ytd_df.columns:\n",
    "        result_df[col] = ytd_df[col]\n",
    "    \n",
    "    # Drop any rows with missing values\n",
    "    result_df = result_df.dropna()\n",
    "    \n",
    "    return result_df\n",
    "\n",
    "def verify_calculations(df, n_random_samples=5):\n",
    "    \"\"\"Comprehensive verification of calculations\"\"\"\n",
    "    print(\"Running verification checks...\")\n",
    "    print(\"\\n1. Random Date Samples:\")\n",
    "    print(\"=\" * 80)\n",
    "    \n",
    "    # Get random dates\n",
    "    random_dates = df.sample(n=n_random_samples).index.sort_values()\n",
    "    \n",
    "    for date in random_dates:\n",
    "        date = pd.to_datetime(date)\n",
    "        \n",
    "        # Get period boundaries\n",
    "        current_quarter_start = date.to_period('Q').start_time\n",
    "        current_year_start = date.to_period('Y').start_time\n",
    "        prev_quarter_end = current_quarter_start - pd.Timedelta(days=1)\n",
    "        prev_year_end = current_year_start - pd.Timedelta(days=1)\n",
    "        \n",
    "        print(f\"\\nDate: {date.strftime('%Y-%m-%d')}\")\n",
    "        print(f\"Previous Quarter End: {prev_quarter_end.strftime('%Y-%m-%d')}\")\n",
    "        print(f\"Previous Year End: {prev_year_end.strftime('%Y-%m-%d')}\")\n",
    "        \n",
    "        # Check calculations for TSX\n",
    "        col = 'tsx'\n",
    "        current_value = df[col][date]\n",
    "        prev_quarter_value = df[df.index <= prev_quarter_end][col].iloc[-1]\n",
    "        prev_year_value = df[df.index <= prev_year_end][col].iloc[-1]\n",
    "        \n",
    "        manual_qtd = (current_value / prev_quarter_value - 1) * 100\n",
    "        manual_ytd = (current_value / prev_year_value - 1) * 100\n",
    "        \n",
    "        print(f\"\\nTSX Values:\")\n",
    "        print(f\"Current: {current_value:.2f}\")\n",
    "        print(f\"Prev Quarter End: {prev_quarter_value:.2f}\")\n",
    "        print(f\"Prev Year End: {prev_year_value:.2f}\")\n",
    "        print(f\"QTD% (Manual): {manual_qtd:.2f}%\")\n",
    "        print(f\"QTD% (Calculated): {df[f'{col}_qtd'][date]:.2f}%\")\n",
    "        print(f\"YTD% (Manual): {manual_ytd:.2f}%\")\n",
    "        print(f\"YTD% (Calculated): {df[f'{col}_ytd'][date]:.2f}%\")\n",
    "        \n",
    "        # Check for significant differences\n",
    "        qtd_diff = abs(manual_qtd - df[f'{col}_qtd'][date])\n",
    "        ytd_diff = abs(manual_ytd - df[f'{col}_ytd'][date])\n",
    "        \n",
    "        if qtd_diff > 0.01:\n",
    "            print(f\"WARNING: Large QTD difference ({qtd_diff:.4f}%)\")\n",
    "        if ytd_diff > 0.01:\n",
    "            print(f\"WARNING: Large YTD difference ({ytd_diff:.4f}%)\")\n",
    "            \n",
    "    print(\"\\n2. Quarter/Year Boundary Checks:\")\n",
    "    print(\"=\" * 80)\n",
    "    \n",
    "    # Find dates near quarter/year boundaries\n",
    "    quarter_starts = df.index[pd.to_datetime(df.index).is_quarter_start]\n",
    "    year_starts = df.index[pd.to_datetime(df.index).is_year_start]\n",
    "    \n",
    "    if len(quarter_starts) > 0:\n",
    "        print(\"\\nFirst day of quarter example:\")\n",
    "        first_quarter_date = quarter_starts[len(quarter_starts)//2]  # Take a middle example\n",
    "        print(f\"Date: {first_quarter_date}\")\n",
    "        print(f\"TSX QTD%: {df.loc[first_quarter_date, 'tsx_qtd']:.2f}%\")\n",
    "        \n",
    "    if len(year_starts) > 0:\n",
    "        print(\"\\nFirst day of year example:\")\n",
    "        first_year_date = year_starts[len(year_starts)//2]  # Take a middle example\n",
    "        print(f\"Date: {first_year_date}\")\n",
    "        print(f\"TSX YTD%: {df.loc[first_year_date, 'tsx_ytd']:.2f}%\")\n",
    "\n",
    "# Calculate all changes\n",
    "print(\"Calculating changes...\")\n",
    "final_df = add_all_changes(final_df)\n",
    "\n",
    "# Run comprehensive verification\n",
    "print(\"\\nRunning verification...\")\n",
    "verify_calculations(final_df)\n",
    "\n",
    "# Show basic info about the final dataset\n",
    "print(\"\\nFinal Dataset Info:\")\n",
    "print(\"=\" * 80)\n",
    "final_df.info()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "Strategy Performance:\n",
      "Start                               2003-09-24 00:00:00\n",
      "End                                 2025-01-31 00:00:00\n",
      "Period                               5493 days 00:00:00\n",
      "Start Value                                    100000.0\n",
      "End Value                                 162043.853315\n",
      "Total Return [%]                              62.043853\n",
      "Benchmark Return [%]                          31.830358\n",
      "Max Gross Exposure [%]                            100.0\n",
      "Total Fees Paid                                     0.0\n",
      "Max Drawdown [%]                               1.967439\n",
      "Max Drawdown Duration                 508 days 00:00:00\n",
      "Total Trades                                        169\n",
      "Total Closed Trades                                 169\n",
      "Total Open Trades                                     0\n",
      "Open Trade PnL                                      0.0\n",
      "Win Rate [%]                                  59.171598\n",
      "Best Trade [%]                                 7.069267\n",
      "Worst Trade [%]                                -0.43424\n",
      "Avg Winning Trade [%]                          0.544884\n",
      "Avg Losing Trade [%]                          -0.079848\n",
      "Avg Winning Trade Duration             27 days 01:12:00\n",
      "Avg Losing Trade Duration     5 days 02:05:13.043478260\n",
      "Profit Factor                                 10.254785\n",
      "Expectancy                                   367.123392\n",
      "Sharpe Ratio                                   2.983259\n",
      "Calmar Ratio                                   1.656685\n",
      "Omega Ratio                                    2.102171\n",
      "Sortino Ratio                                  5.423244\n",
      "dtype: object\n",
      "\n",
      "Buy & Hold Performance:\n",
      "Start                         2003-09-24 00:00:00\n",
      "End                           2025-01-31 00:00:00\n",
      "Period                         5493 days 00:00:00\n",
      "Start Value                              100000.0\n",
      "End Value                            131830.35789\n",
      "Total Return [%]                        31.830358\n",
      "Benchmark Return [%]                    31.830358\n",
      "Max Gross Exposure [%]                      100.0\n",
      "Total Fees Paid                               0.0\n",
      "Max Drawdown [%]                        15.481159\n",
      "Max Drawdown Duration          1005 days 00:00:00\n",
      "Total Trades                                    1\n",
      "Total Closed Trades                             0\n",
      "Total Open Trades                               1\n",
      "Open Trade PnL                        31830.35789\n",
      "Win Rate [%]                                  NaN\n",
      "Best Trade [%]                                NaN\n",
      "Worst Trade [%]                               NaN\n",
      "Avg Winning Trade [%]                         NaN\n",
      "Avg Losing Trade [%]                          NaN\n",
      "Avg Winning Trade Duration                    NaT\n",
      "Avg Losing Trade Duration                     NaT\n",
      "Profit Factor                                 NaN\n",
      "Expectancy                                    NaN\n",
      "Sharpe Ratio                             1.030231\n",
      "Calmar Ratio                             0.119709\n",
      "Omega Ratio                              1.225594\n",
      "Sortino Ratio                            1.360136\n",
      "Name: cad_ig_er_index, dtype: object\n"
     ]
    }
   ],
   "source": [
    "import vectorbt as vbt\n",
    "from vectorbt.portfolio.enums import SizeType\n",
    "\n",
    "# Create signals based on CAD OAS QTD being negative\n",
    "signals = final_df['cad_oas_qtd'] < 0\n",
    "\n",
    "# Create portfolio for our strategy\n",
    "strategy_pf = vbt.Portfolio.from_signals(\n",
    "    final_df['cad_ig_er_index'],\n",
    "    entries=signals,\n",
    "    exits=~signals,\n",
    "    freq='1D',\n",
    "    init_cash=100000,\n",
    "    size=1.0,\n",
    "    size_type=SizeType.Percent,\n",
    "    accumulate=False\n",
    ")\n",
    "\n",
    "# Create buy & hold portfolio for comparison\n",
    "bh_pf = vbt.Portfolio.from_holding(\n",
    "    final_df['cad_ig_er_index'],\n",
    "    freq='1D',\n",
    "    init_cash=100000,\n",
    "    size=1.0,\n",
    "    size_type=SizeType.Percent\n",
    ")\n",
    "\n",
    "# Compare performance metrics\n",
    "print(\"\\nStrategy Performance:\")\n",
    "print(strategy_pf.stats())\n",
    "print(\"\\nBuy & Hold Performance:\")\n",
    "print(bh_pf.stats())"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "Strategy Performance:\n",
      "Start                                2003-09-24 00:00:00\n",
      "End                                  2025-01-31 00:00:00\n",
      "Period                                5493 days 00:00:00\n",
      "Start Value                                     100000.0\n",
      "End Value                                  154744.803811\n",
      "Total Return [%]                               54.744804\n",
      "Benchmark Return [%]                           31.830358\n",
      "Max Gross Exposure [%]                             100.0\n",
      "Total Fees Paid                                      0.0\n",
      "Max Drawdown [%]                                1.839838\n",
      "Max Drawdown Duration                  485 days 00:00:00\n",
      "Total Trades                                          83\n",
      "Total Closed Trades                                   83\n",
      "Total Open Trades                                      0\n",
      "Open Trade PnL                                       0.0\n",
      "Win Rate [%]                                   68.674699\n",
      "Best Trade [%]                                 16.083912\n",
      "Worst Trade [%]                                -0.189953\n",
      "Avg Winning Trade [%]                           0.818268\n",
      "Avg Losing Trade [%]                           -0.050321\n",
      "Avg Winning Trade Duration    52 days 23:34:44.210526316\n",
      "Avg Losing Trade Duration     11 days 16:36:55.384615384\n",
      "Profit Factor                                  36.960005\n",
      "Expectancy                                     659.57595\n",
      "Sharpe Ratio                                    2.899079\n",
      "Calmar Ratio                                    1.599962\n",
      "Omega Ratio                                     1.944367\n",
      "Sortino Ratio                                   4.999901\n",
      "dtype: object\n",
      "\n",
      "Buy & Hold Performance:\n",
      "Start                         2003-09-24 00:00:00\n",
      "End                           2025-01-31 00:00:00\n",
      "Period                         5493 days 00:00:00\n",
      "Start Value                              100000.0\n",
      "End Value                            131830.35789\n",
      "Total Return [%]                        31.830358\n",
      "Benchmark Return [%]                    31.830358\n",
      "Max Gross Exposure [%]                      100.0\n",
      "Total Fees Paid                               0.0\n",
      "Max Drawdown [%]                        15.481159\n",
      "Max Drawdown Duration          1005 days 00:00:00\n",
      "Total Trades                                    1\n",
      "Total Closed Trades                             0\n",
      "Total Open Trades                               1\n",
      "Open Trade PnL                        31830.35789\n",
      "Win Rate [%]                                  NaN\n",
      "Best Trade [%]                                NaN\n",
      "Worst Trade [%]                               NaN\n",
      "Avg Winning Trade [%]                         NaN\n",
      "Avg Losing Trade [%]                          NaN\n",
      "Avg Winning Trade Duration                    NaT\n",
      "Avg Losing Trade Duration                     NaT\n",
      "Profit Factor                                 NaN\n",
      "Expectancy                                    NaN\n",
      "Sharpe Ratio                             1.030231\n",
      "Calmar Ratio                             0.119709\n",
      "Omega Ratio                              1.225594\n",
      "Sortino Ratio                            1.360136\n",
      "Name: cad_ig_er_index, dtype: object\n"
     ]
    }
   ],
   "source": [
    "import vectorbt as vbt\n",
    "from vectorbt.portfolio.enums import SizeType\n",
    "\n",
    "# Create signals based on CAD OAS YTD being negative\n",
    "signals = final_df['cad_oas_ytd'] < 0\n",
    "\n",
    "# Create portfolio for our strategy\n",
    "strategy_pf = vbt.Portfolio.from_signals(\n",
    "    final_df['cad_ig_er_index'],\n",
    "    entries=signals,\n",
    "    exits=~signals,\n",
    "    freq='1D',\n",
    "    init_cash=100000,\n",
    "    size=1.0,\n",
    "    size_type=SizeType.Percent,\n",
    "    accumulate=False\n",
    ")\n",
    "\n",
    "# Create buy & hold portfolio for comparison\n",
    "bh_pf = vbt.Portfolio.from_holding(\n",
    "    final_df['cad_ig_er_index'],\n",
    "    freq='1D',\n",
    "    init_cash=100000,\n",
    "    size=1.0,\n",
    "    size_type=SizeType.Percent\n",
    ")\n",
    "\n",
    "# Compare performance metrics\n",
    "print(\"\\nStrategy Performance:\")\n",
    "print(strategy_pf.stats())\n",
    "print(\"\\nBuy & Hold Performance:\")\n",
    "print(bh_pf.stats())"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "Strategy Performance:\n",
      "Start                                2003-09-24 00:00:00\n",
      "End                                  2025-01-31 00:00:00\n",
      "Period                                5493 days 00:00:00\n",
      "Start Value                                     100000.0\n",
      "End Value                                  146422.127425\n",
      "Total Return [%]                               46.422127\n",
      "Benchmark Return [%]                           31.830358\n",
      "Max Gross Exposure [%]                             100.0\n",
      "Total Fees Paid                                      0.0\n",
      "Max Drawdown [%]                                1.839838\n",
      "Max Drawdown Duration                  509 days 00:00:00\n",
      "Total Trades                                         150\n",
      "Total Closed Trades                                  150\n",
      "Total Open Trades                                      0\n",
      "Open Trade PnL                                       0.0\n",
      "Win Rate [%]                                   57.333333\n",
      "Best Trade [%]                                  7.069267\n",
      "Worst Trade [%]                                -0.336925\n",
      "Avg Winning Trade [%]                           0.494261\n",
      "Avg Losing Trade [%]                           -0.060544\n",
      "Avg Winning Trade Duration    26 days 07:15:20.930232558\n",
      "Avg Losing Trade Duration                4 days 06:00:00\n",
      "Profit Factor                                  10.897867\n",
      "Expectancy                                    309.480849\n",
      "Sharpe Ratio                                    2.779278\n",
      "Calmar Ratio                                    1.394798\n",
      "Omega Ratio                                     2.128167\n",
      "Sortino Ratio                                    4.94886\n",
      "dtype: object\n",
      "\n",
      "Buy & Hold Performance:\n",
      "Start                         2003-09-24 00:00:00\n",
      "End                           2025-01-31 00:00:00\n",
      "Period                         5493 days 00:00:00\n",
      "Start Value                              100000.0\n",
      "End Value                            131830.35789\n",
      "Total Return [%]                        31.830358\n",
      "Benchmark Return [%]                    31.830358\n",
      "Max Gross Exposure [%]                      100.0\n",
      "Total Fees Paid                               0.0\n",
      "Max Drawdown [%]                        15.481159\n",
      "Max Drawdown Duration          1005 days 00:00:00\n",
      "Total Trades                                    1\n",
      "Total Closed Trades                             0\n",
      "Total Open Trades                               1\n",
      "Open Trade PnL                        31830.35789\n",
      "Win Rate [%]                                  NaN\n",
      "Best Trade [%]                                NaN\n",
      "Worst Trade [%]                               NaN\n",
      "Avg Winning Trade [%]                         NaN\n",
      "Avg Losing Trade [%]                          NaN\n",
      "Avg Winning Trade Duration                    NaT\n",
      "Avg Losing Trade Duration                     NaT\n",
      "Profit Factor                                 NaN\n",
      "Expectancy                                    NaN\n",
      "Sharpe Ratio                             1.030231\n",
      "Calmar Ratio                             0.119709\n",
      "Omega Ratio                              1.225594\n",
      "Sortino Ratio                            1.360136\n",
      "Name: cad_ig_er_index, dtype: object\n"
     ]
    }
   ],
   "source": [
    "import vectorbt as vbt\n",
    "from vectorbt.portfolio.enums import SizeType\n",
    "\n",
    "# Create signals based on both CAD OAS QTD and YTD being negative\n",
    "signals = (final_df['cad_oas_qtd'] < 0) & (final_df['cad_oas_ytd'] < 0)\n",
    "\n",
    "# Create portfolio for our strategy\n",
    "strategy_pf = vbt.Portfolio.from_signals(\n",
    "    final_df['cad_ig_er_index'],\n",
    "    entries=signals,\n",
    "    exits=~signals,\n",
    "    freq='1D',\n",
    "    init_cash=100000,\n",
    "    size=1.0,\n",
    "    size_type=SizeType.Percent,\n",
    "    accumulate=False\n",
    ")\n",
    "\n",
    "# Create buy & hold portfolio for comparison\n",
    "bh_pf = vbt.Portfolio.from_holding(\n",
    "    final_df['cad_ig_er_index'],\n",
    "    freq='1D',\n",
    "    init_cash=100000,\n",
    "    size=1.0,\n",
    "    size_type=SizeType.Percent\n",
    ")\n",
    "\n",
    "# Compare performance metrics\n",
    "print(\"\\nStrategy Performance:\")\n",
    "print(strategy_pf.stats())\n",
    "print(\"\\nBuy & Hold Performance:\")\n",
    "print(bh_pf.stats())"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "Strategy Performance:\n",
      "Start                         2003-09-24 00:00:00\n",
      "End                           2025-01-31 00:00:00\n",
      "Period                         5493 days 00:00:00\n",
      "Start Value                              100000.0\n",
      "End Value                           171254.473153\n",
      "Total Return [%]                        71.254473\n",
      "Benchmark Return [%]                    31.830358\n",
      "Max Gross Exposure [%]                      100.0\n",
      "Total Fees Paid                               0.0\n",
      "Max Drawdown [%]                         1.839838\n",
      "Max Drawdown Duration           405 days 00:00:00\n",
      "Total Trades                                  102\n",
      "Total Closed Trades                           102\n",
      "Total Open Trades                               0\n",
      "Open Trade PnL                                0.0\n",
      "Win Rate [%]                            70.588235\n",
      "Best Trade [%]                          16.083912\n",
      "Worst Trade [%]                          -0.43424\n",
      "Avg Winning Trade [%]                    0.811917\n",
      "Avg Losing Trade [%]                    -0.092335\n",
      "Avg Winning Trade Duration       48 days 05:20:00\n",
      "Avg Losing Trade Duration        12 days 11:12:00\n",
      "Profit Factor                           22.626127\n",
      "Expectancy                             698.573266\n",
      "Sharpe Ratio                             3.105773\n",
      "Calmar Ratio                             1.978135\n",
      "Omega Ratio                              1.956809\n",
      "Sortino Ratio                            5.487925\n",
      "dtype: object\n",
      "\n",
      "Buy & Hold Performance:\n",
      "Start                         2003-09-24 00:00:00\n",
      "End                           2025-01-31 00:00:00\n",
      "Period                         5493 days 00:00:00\n",
      "Start Value                              100000.0\n",
      "End Value                            131830.35789\n",
      "Total Return [%]                        31.830358\n",
      "Benchmark Return [%]                    31.830358\n",
      "Max Gross Exposure [%]                      100.0\n",
      "Total Fees Paid                               0.0\n",
      "Max Drawdown [%]                        15.481159\n",
      "Max Drawdown Duration          1005 days 00:00:00\n",
      "Total Trades                                    1\n",
      "Total Closed Trades                             0\n",
      "Total Open Trades                               1\n",
      "Open Trade PnL                        31830.35789\n",
      "Win Rate [%]                                  NaN\n",
      "Best Trade [%]                                NaN\n",
      "Worst Trade [%]                               NaN\n",
      "Avg Winning Trade [%]                         NaN\n",
      "Avg Losing Trade [%]                          NaN\n",
      "Avg Winning Trade Duration                    NaT\n",
      "Avg Losing Trade Duration                     NaT\n",
      "Profit Factor                                 NaN\n",
      "Expectancy                                    NaN\n",
      "Sharpe Ratio                             1.030231\n",
      "Calmar Ratio                             0.119709\n",
      "Omega Ratio                              1.225594\n",
      "Sortino Ratio                            1.360136\n",
      "Name: cad_ig_er_index, dtype: object\n"
     ]
    }
   ],
   "source": [
    "import vectorbt as vbt\n",
    "from vectorbt.portfolio.enums import SizeType\n",
    "\n",
    "# Create signals based on either CAD OAS QTD or YTD being negative\n",
    "signals = (final_df['cad_oas_qtd'] < 0) | (final_df['cad_oas_ytd'] < 0)\n",
    "\n",
    "# Create portfolio for our strategy\n",
    "strategy_pf = vbt.Portfolio.from_signals(\n",
    "    final_df['cad_ig_er_index'],\n",
    "    entries=signals,\n",
    "    exits=~signals,\n",
    "    freq='1D',\n",
    "    init_cash=100000,\n",
    "    size=1.0,\n",
    "    size_type=SizeType.Percent,\n",
    "    accumulate=False\n",
    ")\n",
    "\n",
    "# Create buy & hold portfolio for comparison\n",
    "bh_pf = vbt.Portfolio.from_holding(\n",
    "    final_df['cad_ig_er_index'],\n",
    "    freq='1D',\n",
    "    init_cash=100000,\n",
    "    size=1.0,\n",
    "    size_type=SizeType.Percent\n",
    ")\n",
    "\n",
    "# Compare performance metrics\n",
    "print(\"\\nStrategy Performance:\")\n",
    "print(strategy_pf.stats())\n",
    "print(\"\\nBuy & Hold Performance:\")\n",
    "print(bh_pf.stats())"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "Strategy Comparison:\n",
      "                             Start        End    Period  Start Value  \\\n",
      "cad_ig_er_index_3m_pos  2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "cad_ig_er_index_1yr_pos 2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "cad_ig_er_index_qtd_pos 2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "cad_ig_er_index_ytd_pos 2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "us_hy_er_index_3m_pos   2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "us_hy_er_index_1yr_pos  2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "us_hy_er_index_qtd_pos  2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "us_hy_er_index_ytd_pos  2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "us_ig_er_index_3m_pos   2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "us_ig_er_index_1yr_pos  2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "us_ig_er_index_qtd_pos  2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "us_ig_er_index_ytd_pos  2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "tsx_3m_pos              2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "tsx_1yr_pos             2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "tsx_qtd_pos             2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "tsx_ytd_pos             2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "cad_oas_3m_neg          2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "cad_oas_1yr_neg         2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "cad_oas_qtd_neg         2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "cad_oas_ytd_neg         2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "us_hy_oas_3m_neg        2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "us_hy_oas_1yr_neg       2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "us_hy_oas_qtd_neg       2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "us_hy_oas_ytd_neg       2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "us_ig_oas_3m_neg        2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "us_ig_oas_1yr_neg       2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "us_ig_oas_qtd_neg       2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "us_ig_oas_ytd_neg       2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "vix_3m_neg              2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "vix_1yr_neg             2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "vix_qtd_neg             2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "vix_ytd_neg             2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "buy_and_hold            2003-09-24 2025-01-31 5493 days     100000.0   \n",
      "\n",
      "                             End Value  Total Return [%]  \\\n",
      "cad_ig_er_index_3m_pos   153120.554949         53.120555   \n",
      "cad_ig_er_index_1yr_pos  128650.727065         28.650727   \n",
      "cad_ig_er_index_qtd_pos  172785.570166         72.785570   \n",
      "cad_ig_er_index_ytd_pos  157642.929570         57.642930   \n",
      "us_hy_er_index_3m_pos    163919.340114         63.919340   \n",
      "us_hy_er_index_1yr_pos   131064.462961         31.064463   \n",
      "us_hy_er_index_qtd_pos   183766.300580         83.766301   \n",
      "us_hy_er_index_ytd_pos   158797.347304         58.797347   \n",
      "us_ig_er_index_3m_pos    163131.086734         63.131087   \n",
      "us_ig_er_index_1yr_pos   131120.174523         31.120175   \n",
      "us_ig_er_index_qtd_pos   181233.155175         81.233155   \n",
      "us_ig_er_index_ytd_pos   157208.227024         57.208227   \n",
      "tsx_3m_pos               163158.909107         63.158909   \n",
      "tsx_1yr_pos              119918.888214         19.918888   \n",
      "tsx_qtd_pos              179927.539905         79.927540   \n",
      "tsx_ytd_pos              155325.688520         55.325689   \n",
      "cad_oas_3m_neg           151285.228185         51.285228   \n",
      "cad_oas_1yr_neg          123772.233393         23.772233   \n",
      "cad_oas_qtd_neg          162043.853315         62.043853   \n",
      "cad_oas_ytd_neg          154744.803811         54.744804   \n",
      "us_hy_oas_3m_neg         160091.901294         60.091901   \n",
      "us_hy_oas_1yr_neg        128437.623502         28.437624   \n",
      "us_hy_oas_qtd_neg        177708.128233         77.708128   \n",
      "us_hy_oas_ytd_neg        159235.986378         59.235986   \n",
      "us_ig_oas_3m_neg         163038.929967         63.038930   \n",
      "us_ig_oas_1yr_neg        132839.572273         32.839572   \n",
      "us_ig_oas_qtd_neg        183067.963694         83.067964   \n",
      "us_ig_oas_ytd_neg        155878.929950         55.878930   \n",
      "vix_3m_neg               168715.374323         68.715374   \n",
      "vix_1yr_neg              137428.861218         37.428861   \n",
      "vix_qtd_neg              176799.215771         76.799216   \n",
      "vix_ytd_neg              160416.757472         60.416757   \n",
      "buy_and_hold             131830.357890         31.830358   \n",
      "\n",
      "                         Benchmark Return [%]  Max Gross Exposure [%]  \\\n",
      "cad_ig_er_index_3m_pos              31.830358                   100.0   \n",
      "cad_ig_er_index_1yr_pos             31.830358                   100.0   \n",
      "cad_ig_er_index_qtd_pos             31.830358                   100.0   \n",
      "cad_ig_er_index_ytd_pos             31.830358                   100.0   \n",
      "us_hy_er_index_3m_pos               31.830358                   100.0   \n",
      "us_hy_er_index_1yr_pos              31.830358                   100.0   \n",
      "us_hy_er_index_qtd_pos              31.830358                   100.0   \n",
      "us_hy_er_index_ytd_pos              31.830358                   100.0   \n",
      "us_ig_er_index_3m_pos               31.830358                   100.0   \n",
      "us_ig_er_index_1yr_pos              31.830358                   100.0   \n",
      "us_ig_er_index_qtd_pos              31.830358                   100.0   \n",
      "us_ig_er_index_ytd_pos              31.830358                   100.0   \n",
      "tsx_3m_pos                          31.830358                   100.0   \n",
      "tsx_1yr_pos                         31.830358                   100.0   \n",
      "tsx_qtd_pos                         31.830358                   100.0   \n",
      "tsx_ytd_pos                         31.830358                   100.0   \n",
      "cad_oas_3m_neg                      31.830358                   100.0   \n",
      "cad_oas_1yr_neg                     31.830358                   100.0   \n",
      "cad_oas_qtd_neg                     31.830358                   100.0   \n",
      "cad_oas_ytd_neg                     31.830358                   100.0   \n",
      "us_hy_oas_3m_neg                    31.830358                   100.0   \n",
      "us_hy_oas_1yr_neg                   31.830358                   100.0   \n",
      "us_hy_oas_qtd_neg                   31.830358                   100.0   \n",
      "us_hy_oas_ytd_neg                   31.830358                   100.0   \n",
      "us_ig_oas_3m_neg                    31.830358                   100.0   \n",
      "us_ig_oas_1yr_neg                   31.830358                   100.0   \n",
      "us_ig_oas_qtd_neg                   31.830358                   100.0   \n",
      "us_ig_oas_ytd_neg                   31.830358                   100.0   \n",
      "vix_3m_neg                          31.830358                   100.0   \n",
      "vix_1yr_neg                         31.830358                   100.0   \n",
      "vix_qtd_neg                         31.830358                   100.0   \n",
      "vix_ytd_neg                         31.830358                   100.0   \n",
      "buy_and_hold                        31.830358                   100.0   \n",
      "\n",
      "                         Total Fees Paid  Max Drawdown [%]  ...  \\\n",
      "cad_ig_er_index_3m_pos               0.0          1.601274  ...   \n",
      "cad_ig_er_index_1yr_pos              0.0          3.929956  ...   \n",
      "cad_ig_er_index_qtd_pos              0.0          1.839838  ...   \n",
      "cad_ig_er_index_ytd_pos              0.0          1.890074  ...   \n",
      "us_hy_er_index_3m_pos                0.0          2.175584  ...   \n",
      "us_hy_er_index_1yr_pos               0.0          2.402191  ...   \n",
      "us_hy_er_index_qtd_pos               0.0          1.839838  ...   \n",
      "us_hy_er_index_ytd_pos               0.0          1.929941  ...   \n",
      "us_ig_er_index_3m_pos                0.0          2.309203  ...   \n",
      "us_ig_er_index_1yr_pos               0.0          2.402191  ...   \n",
      "us_ig_er_index_qtd_pos               0.0          1.839838  ...   \n",
      "us_ig_er_index_ytd_pos               0.0          1.839838  ...   \n",
      "tsx_3m_pos                           0.0          2.815608  ...   \n",
      "tsx_1yr_pos                          0.0          6.563281  ...   \n",
      "tsx_qtd_pos                          0.0          2.194076  ...   \n",
      "tsx_ytd_pos                          0.0          4.468584  ...   \n",
      "cad_oas_3m_neg                       0.0          1.654301  ...   \n",
      "cad_oas_1yr_neg                      0.0          2.598070  ...   \n",
      "cad_oas_qtd_neg                      0.0          1.967439  ...   \n",
      "cad_oas_ytd_neg                      0.0          1.839838  ...   \n",
      "us_hy_oas_3m_neg                     0.0          1.839838  ...   \n",
      "us_hy_oas_1yr_neg                    0.0          2.402191  ...   \n",
      "us_hy_oas_qtd_neg                    0.0          1.712487  ...   \n",
      "us_hy_oas_ytd_neg                    0.0          1.712487  ...   \n",
      "us_ig_oas_3m_neg                     0.0          2.218917  ...   \n",
      "us_ig_oas_1yr_neg                    0.0          2.402191  ...   \n",
      "us_ig_oas_qtd_neg                    0.0          1.839838  ...   \n",
      "us_ig_oas_ytd_neg                    0.0          1.839838  ...   \n",
      "vix_3m_neg                           0.0          1.891928  ...   \n",
      "vix_1yr_neg                          0.0          1.626081  ...   \n",
      "vix_qtd_neg                          0.0          1.738030  ...   \n",
      "vix_ytd_neg                          0.0          1.603420  ...   \n",
      "buy_and_hold                         0.0         15.481159  ...   \n",
      "\n",
      "                        Avg Winning Trade [%]  Avg Losing Trade [%]  \\\n",
      "cad_ig_er_index_3m_pos               1.654524             -0.110793   \n",
      "cad_ig_er_index_1yr_pos              2.436330             -0.295799   \n",
      "cad_ig_er_index_qtd_pos              1.632153             -0.071180   \n",
      "cad_ig_er_index_ytd_pos              4.056865             -0.053823   \n",
      "us_hy_er_index_3m_pos                1.064890             -0.131043   \n",
      "us_hy_er_index_1yr_pos               1.267298             -0.174864   \n",
      "us_hy_er_index_qtd_pos               0.880377             -0.112995   \n",
      "us_hy_er_index_ytd_pos               1.940347             -0.186566   \n",
      "us_ig_er_index_3m_pos                1.225746             -0.108311   \n",
      "us_ig_er_index_1yr_pos               1.575651             -0.147755   \n",
      "us_ig_er_index_qtd_pos               0.827649             -0.118995   \n",
      "us_ig_er_index_ytd_pos               1.496997             -0.177658   \n",
      "tsx_3m_pos                           0.629104             -0.203919   \n",
      "tsx_1yr_pos                          0.655071             -0.343743   \n",
      "tsx_qtd_pos                          0.529106             -0.119544   \n",
      "tsx_ytd_pos                          0.882059             -0.307516   \n",
      "cad_oas_3m_neg                       0.587665             -0.066678   \n",
      "cad_oas_1yr_neg                      0.642180             -0.146466   \n",
      "cad_oas_qtd_neg                      0.544884             -0.079848   \n",
      "cad_oas_ytd_neg                      0.818268             -0.050321   \n",
      "us_hy_oas_3m_neg                     0.863113             -0.097738   \n",
      "us_hy_oas_1yr_neg                    1.075576             -0.129979   \n",
      "us_hy_oas_qtd_neg                    0.627817             -0.077330   \n",
      "us_hy_oas_ytd_neg                    1.080524             -0.123703   \n",
      "us_ig_oas_3m_neg                     0.960973             -0.106093   \n",
      "us_ig_oas_1yr_neg                    0.992613             -0.039550   \n",
      "us_ig_oas_qtd_neg                    0.887037             -0.113730   \n",
      "us_ig_oas_ytd_neg                    1.556662             -0.164753   \n",
      "vix_3m_neg                           0.344771             -0.105660   \n",
      "vix_1yr_neg                          0.311317             -0.097605   \n",
      "vix_qtd_neg                          0.354523             -0.108747   \n",
      "vix_ytd_neg                          0.501476             -0.124401   \n",
      "buy_and_hold                              NaN                   NaN   \n",
      "\n",
      "                         Avg Winning Trade Duration  \\\n",
      "cad_ig_er_index_3m_pos            120 days 18:00:00   \n",
      "cad_ig_er_index_1yr_pos           344 days 10:40:00   \n",
      "cad_ig_er_index_qtd_pos  87 days 08:50:31.578947368   \n",
      "cad_ig_er_index_ytd_pos           299 days 00:00:00   \n",
      "us_hy_er_index_3m_pos              70 days 22:00:00   \n",
      "us_hy_er_index_1yr_pos  157 days 08:50:31.578947370   \n",
      "us_hy_er_index_qtd_pos   46 days 07:47:01.621621621   \n",
      "us_hy_er_index_ytd_pos  130 days 13:50:46.153846152   \n",
      "us_ig_er_index_3m_pos              83 days 00:00:00   \n",
      "us_ig_er_index_1yr_pos  202 days 08:34:17.142857144   \n",
      "us_ig_er_index_qtd_pos   46 days 06:09:13.846153846   \n",
      "us_ig_er_index_ytd_pos  103 days 17:27:16.363636364   \n",
      "tsx_3m_pos               36 days 12:08:16.551724138   \n",
      "tsx_1yr_pos              63 days 20:21:49.090909091   \n",
      "tsx_qtd_pos              26 days 06:14:38.048780488   \n",
      "tsx_ytd_pos                        58 days 21:36:00   \n",
      "cad_oas_3m_neg           34 days 10:44:12.631578947   \n",
      "cad_oas_1yr_neg          70 days 13:09:40.645161290   \n",
      "cad_oas_qtd_neg                    27 days 01:12:00   \n",
      "cad_oas_ytd_neg          52 days 23:34:44.210526316   \n",
      "us_hy_oas_3m_neg         52 days 09:55:51.724137931   \n",
      "us_hy_oas_1yr_neg       117 days 14:36:31.304347826   \n",
      "us_hy_oas_qtd_neg                  32 days 00:30:00   \n",
      "us_hy_oas_ytd_neg                  71 days 12:48:00   \n",
      "us_ig_oas_3m_neg                   58 days 01:46:40   \n",
      "us_ig_oas_1yr_neg                 109 days 10:00:00   \n",
      "us_ig_oas_qtd_neg        45 days 01:38:37.808219178   \n",
      "us_ig_oas_ytd_neg       101 days 20:54:11.612903226   \n",
      "vix_3m_neg               14 days 22:32:29.171270718   \n",
      "vix_1yr_neg                        22 days 13:12:00   \n",
      "vix_qtd_neg              15 days 00:15:49.450549450   \n",
      "vix_ytd_neg                        26 days 17:46:40   \n",
      "buy_and_hold                                    NaT   \n",
      "\n",
      "                         Avg Losing Trade Duration  Profit Factor  \\\n",
      "cad_ig_er_index_3m_pos   8 days 18:09:43.783783783      11.569585   \n",
      "cad_ig_er_index_1yr_pos           52 days 21:36:00       7.094467   \n",
      "cad_ig_er_index_qtd_pos            9 days 01:12:00      11.188255   \n",
      "cad_ig_er_index_ytd_pos           21 days 02:00:00      36.175202   \n",
      "us_hy_er_index_3m_pos             27 days 04:30:00      23.765925   \n",
      "us_hy_er_index_1yr_pos  33 days 10:17:08.571428571       9.707303   \n",
      "us_hy_er_index_qtd_pos  13 days 01:50:46.153846153      15.584712   \n",
      "us_hy_er_index_ytd_pos  17 days 05:32:18.461538461      10.228731   \n",
      "us_ig_er_index_3m_pos    8 days 11:17:38.823529411      27.200784   \n",
      "us_ig_er_index_1yr_pos            41 days 15:00:00      19.172203   \n",
      "us_ig_er_index_qtd_pos             7 days 00:48:00      19.955508   \n",
      "us_ig_er_index_ytd_pos            11 days 04:48:00      20.114540   \n",
      "tsx_3m_pos               9 days 06:32:43.636363636       8.583568   \n",
      "tsx_1yr_pos             91 days 18:39:59.999999999       3.486307   \n",
      "tsx_qtd_pos              8 days 14:05:13.043478260      12.387090   \n",
      "tsx_ytd_pos                       15 days 17:00:00       7.656186   \n",
      "cad_oas_3m_neg           4 days 16:56:28.235294117      13.022492   \n",
      "cad_oas_1yr_neg                   13 days 01:55:12       5.327594   \n",
      "cad_oas_qtd_neg          5 days 02:05:13.043478260      10.254785   \n",
      "cad_oas_ytd_neg         11 days 16:36:55.384615384      36.960005   \n",
      "us_hy_oas_3m_neg         6 days 16:27:25.714285714      14.231621   \n",
      "us_hy_oas_1yr_neg                 41 days 14:24:00      19.212340   \n",
      "us_hy_oas_qtd_neg        7 days 16:44:39.069767441      20.321075   \n",
      "us_hy_oas_ytd_neg       10 days 08:28:14.117647058      24.520389   \n",
      "us_ig_oas_3m_neg         6 days 02:49:24.705882352      28.473839   \n",
      "us_ig_oas_1yr_neg        4 days 10:17:08.571428571      80.445940   \n",
      "us_ig_oas_qtd_neg        8 days 07:18:15.652173913      27.165879   \n",
      "us_ig_oas_ytd_neg                  9 days 04:00:00      23.707667   \n",
      "vix_3m_neg               4 days 16:39:31.764705882       7.056258   \n",
      "vix_1yr_neg                        6 days 00:00:00       7.378139   \n",
      "vix_qtd_neg              6 days 12:46:27.096774193      10.057460   \n",
      "vix_ytd_neg                        5 days 22:56:00       9.902149   \n",
      "buy_and_hold                                   NaT            NaN   \n",
      "\n",
      "                          Expectancy  Sharpe Ratio  Calmar Ratio  Omega Ratio  \\\n",
      "cad_ig_er_index_3m_pos    774.274446      2.816069      1.793271     1.786683   \n",
      "cad_ig_er_index_1yr_pos  1067.234188      1.494601      0.429554     1.379846   \n",
      "cad_ig_er_index_qtd_pos   616.826866      3.124270      2.011461     1.931302   \n",
      "cad_ig_er_index_ytd_pos  1601.192488      2.730992      1.624632     1.747273   \n",
      "us_hy_er_index_3m_pos     950.317942      3.164087      1.534491     1.914037   \n",
      "us_hy_er_index_1yr_pos    715.079208      1.794717      0.755062     1.438533   \n",
      "us_hy_er_index_qtd_pos    721.255421      3.359786      2.242695     2.071148   \n",
      "us_hy_er_index_ytd_pos   1050.317512      2.804147      1.616971     1.772755   \n",
      "us_ig_er_index_3m_pos    1037.527969      3.116206      1.431368     1.971721   \n",
      "us_ig_er_index_1yr_pos   1032.249610      1.943312      0.756259     1.495409   \n",
      "us_ig_er_index_qtd_pos    753.308072      3.388235      2.190519     2.114343   \n",
      "us_ig_er_index_ytd_pos   1194.081047      2.908908      1.658714     1.870221   \n",
      "tsx_3m_pos                493.244065      3.303716      1.174343     2.015979   \n",
      "tsx_1yr_pos               306.393962      1.072071      0.185016     1.264006   \n",
      "tsx_qtd_pos               469.987866      3.442513      1.814081     2.176082   \n",
      "tsx_ytd_pos               648.059607      2.743933      0.664484     1.760409   \n",
      "cad_oas_3m_neg            381.519426      2.963776      1.685982     2.033975   \n",
      "cad_oas_1yr_neg           306.838379      1.754342      0.549350     1.494707   \n",
      "cad_oas_qtd_neg           367.123392      2.983259      1.656685     2.102171   \n",
      "cad_oas_ytd_neg           659.575950      2.899079      1.599962     1.944367   \n",
      "us_hy_oas_3m_neg          609.405674      3.125406      1.726406     2.038297   \n",
      "us_hy_oas_1yr_neg         782.068757      2.051717      0.698082     1.546207   \n",
      "us_hy_oas_qtd_neg         536.664436      3.311966      2.274185     2.158767   \n",
      "us_hy_oas_ytd_neg         911.809956      3.000462      1.833334     1.964651   \n",
      "us_ig_oas_3m_neg          889.444878      3.205084      1.487861     2.112192   \n",
      "us_ig_oas_1yr_neg         838.718154      2.277552      0.792967     1.643931   \n",
      "us_ig_oas_qtd_neg         866.597258      3.439247      2.228378     2.224345   \n",
      "us_ig_oas_ytd_neg        1301.992623      2.913480      1.627118     1.962991   \n",
      "vix_3m_neg                255.103854      3.346995      1.869325     2.236918   \n",
      "vix_1yr_neg               215.108398      2.713169      1.313036     1.800658   \n",
      "vix_qtd_neg               313.120326      3.585718      2.220397     2.391517   \n",
      "vix_ytd_neg               395.189837      3.460815      1.989625     2.197898   \n",
      "buy_and_hold                     NaN      1.030231      0.119709     1.225594   \n",
      "\n",
      "                         Sortino Ratio  \n",
      "cad_ig_er_index_3m_pos        4.638287  \n",
      "cad_ig_er_index_1yr_pos       1.920862  \n",
      "cad_ig_er_index_qtd_pos       5.509270  \n",
      "cad_ig_er_index_ytd_pos       4.438013  \n",
      "us_hy_er_index_3m_pos         5.301000  \n",
      "us_hy_er_index_1yr_pos        2.571608  \n",
      "us_hy_er_index_qtd_pos        6.051269  \n",
      "us_hy_er_index_ytd_pos        4.605090  \n",
      "us_ig_er_index_3m_pos         5.305659  \n",
      "us_ig_er_index_1yr_pos        2.676192  \n",
      "us_ig_er_index_qtd_pos        6.134928  \n",
      "us_ig_er_index_ytd_pos        4.867823  \n",
      "tsx_3m_pos                    5.616302  \n",
      "tsx_1yr_pos                   1.352803  \n",
      "tsx_qtd_pos                   6.345684  \n",
      "tsx_ytd_pos                   4.398573  \n",
      "cad_oas_3m_neg                5.154409  \n",
      "cad_oas_1yr_neg               2.427471  \n",
      "cad_oas_qtd_neg               5.423244  \n",
      "cad_oas_ytd_neg               4.999901  \n",
      "us_hy_oas_3m_neg              5.310778  \n",
      "us_hy_oas_1yr_neg             2.965816  \n",
      "us_hy_oas_qtd_neg             6.017639  \n",
      "us_hy_oas_ytd_neg             5.139594  \n",
      "us_ig_oas_3m_neg              5.584726  \n",
      "us_ig_oas_1yr_neg             3.347239  \n",
      "us_ig_oas_qtd_neg             6.357342  \n",
      "us_ig_oas_ytd_neg             5.014954  \n",
      "vix_3m_neg                    6.141965  \n",
      "vix_1yr_neg                   4.274413  \n",
      "vix_qtd_neg                   7.305392  \n",
      "vix_ytd_neg                   6.600059  \n",
      "buy_and_hold                  1.360136  \n",
      "\n",
      "[33 rows x 28 columns]\n"
     ]
    }
   ],
   "source": [
    "import vectorbt as vbt\n",
    "from vectorbt.portfolio.enums import SizeType\n",
    "import pandas as pd\n",
    "\n",
    "# Define our indicators and their types\n",
    "positive_indicators = ['cad_ig_er_index', 'us_hy_er_index', 'us_ig_er_index', 'tsx']\n",
    "negative_indicators = ['cad_oas', 'us_hy_oas', 'us_ig_oas', 'vix']\n",
    "intervals = ['3m', '1yr', 'qtd', 'ytd']\n",
    "\n",
    "# Dictionary to store all portfolios\n",
    "portfolios = {}\n",
    "\n",
    "# Create strategies for positive indicators\n",
    "for indicator in positive_indicators:\n",
    "    for interval in intervals:\n",
    "        col_name = f'{indicator}_{interval}'\n",
    "        strategy_name = f'{indicator}_{interval}_pos'\n",
    "        signals = final_df[col_name] > 0\n",
    "        \n",
    "        portfolios[strategy_name] = vbt.Portfolio.from_signals(\n",
    "            final_df['cad_ig_er_index'],\n",
    "            entries=signals,\n",
    "            exits=~signals,\n",
    "            freq='1D',\n",
    "            init_cash=100000,\n",
    "            size=1.0,\n",
    "            size_type=SizeType.Percent,\n",
    "            accumulate=False\n",
    "        )\n",
    "\n",
    "# Create strategies for negative indicators\n",
    "for indicator in negative_indicators:\n",
    "    for interval in intervals:\n",
    "        col_name = f'{indicator}_{interval}'\n",
    "        strategy_name = f'{indicator}_{interval}_neg'\n",
    "        signals = final_df[col_name] < 0\n",
    "        \n",
    "        portfolios[strategy_name] = vbt.Portfolio.from_signals(\n",
    "            final_df['cad_ig_er_index'],\n",
    "            entries=signals,\n",
    "            exits=~signals,\n",
    "            freq='1D',\n",
    "            init_cash=100000,\n",
    "            size=1.0,\n",
    "            size_type=SizeType.Percent,\n",
    "            accumulate=False\n",
    "        )\n",
    "\n",
    "# Create buy & hold portfolio for comparison\n",
    "bh_pf = vbt.Portfolio.from_holding(\n",
    "    final_df['cad_ig_er_index'],\n",
    "    freq='1D',\n",
    "    init_cash=100000,\n",
    "    size=1.0,\n",
    "    size_type=SizeType.Percent\n",
    ")\n",
    "portfolios['buy_and_hold'] = bh_pf\n",
    "\n",
    "# Create a comparison DataFrame\n",
    "stats_list = []\n",
    "for name, pf in portfolios.items():\n",
    "    stats = pf.stats()\n",
    "    stats_list.append(pd.Series(stats, name=name))\n",
    "\n",
    "comparison_df = pd.DataFrame(stats_list)\n",
    "\n",
    "# Display results\n",
    "print(\"\\nStrategy Comparison:\")\n",
    "print(comparison_df)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "Data Overview:\n",
      "final_df shape: (5493, 40)\n",
      "final_df columns: ['cad_oas', 'us_hy_oas', 'us_ig_oas', 'tsx', 'vix', 'cad_ig_er_index', 'us_hy_er_index', 'us_ig_er_index', 'cad_oas_3m', 'cad_oas_1yr', 'us_hy_oas_3m', 'us_hy_oas_1yr', 'us_ig_oas_3m', 'us_ig_oas_1yr', 'tsx_3m', 'tsx_1yr', 'vix_3m', 'vix_1yr', 'cad_ig_er_index_3m', 'cad_ig_er_index_1yr', 'us_hy_er_index_3m', 'us_hy_er_index_1yr', 'us_ig_er_index_3m', 'us_ig_er_index_1yr', 'cad_oas_qtd', 'us_hy_oas_qtd', 'us_ig_oas_qtd', 'tsx_qtd', 'vix_qtd', 'cad_ig_er_index_qtd', 'us_hy_er_index_qtd', 'us_ig_er_index_qtd', 'cad_oas_ytd', 'us_hy_oas_ytd', 'us_ig_oas_ytd', 'tsx_ytd', 'vix_ytd', 'cad_ig_er_index_ytd', 'us_hy_er_index_ytd', 'us_ig_er_index_ytd']\n",
      "final_df index: 2003-09-24 00:00:00 to 2025-01-31 00:00:00\n",
      "\n",
      "Generating positive signals...\n",
      "\n",
      "Generating signal for cad_ig_er_index_3m_<lambda>:\n",
      "Signal True values: 3806\n",
      "Signal False values: 1687\n",
      "\n",
      "Generating signal for cad_ig_er_index_1yr_<lambda>:\n",
      "Signal True values: 4112\n",
      "Signal False values: 1381\n",
      "\n",
      "Generating signal for cad_ig_er_index_qtd_<lambda>:\n",
      "Signal True values: 4044\n",
      "Signal False values: 1449\n",
      "\n",
      "Generating signal for cad_ig_er_index_ytd_<lambda>:\n",
      "Signal True values: 4094\n",
      "Signal False values: 1399\n",
      "\n",
      "Generating signal for us_hy_er_index_3m_<lambda>:\n",
      "Signal True values: 3960\n",
      "Signal False values: 1533\n",
      "\n",
      "Generating signal for us_hy_er_index_1yr_<lambda>:\n",
      "Signal True values: 3927\n",
      "Signal False values: 1566\n",
      "\n",
      "Generating signal for us_hy_er_index_qtd_<lambda>:\n",
      "Signal True values: 4024\n",
      "Signal False values: 1469\n",
      "\n",
      "Generating signal for us_hy_er_index_ytd_<lambda>:\n",
      "Signal True values: 4103\n",
      "Signal False values: 1390\n",
      "\n",
      "Generating signal for us_ig_er_index_3m_<lambda>:\n",
      "Signal True values: 3647\n",
      "Signal False values: 1846\n",
      "\n",
      "Generating signal for us_ig_er_index_1yr_<lambda>:\n",
      "Signal True values: 3646\n",
      "Signal False values: 1847\n",
      "\n",
      "Generating signal for us_ig_er_index_qtd_<lambda>:\n",
      "Signal True values: 3832\n",
      "Signal False values: 1661\n",
      "\n",
      "Generating signal for us_ig_er_index_ytd_<lambda>:\n",
      "Signal True values: 3604\n",
      "Signal False values: 1889\n",
      "\n",
      "Generating signal for tsx_3m_<lambda>:\n",
      "Signal True values: 3608\n",
      "Signal False values: 1885\n",
      "\n",
      "Generating signal for tsx_1yr_<lambda>:\n",
      "Signal True values: 4031\n",
      "Signal False values: 1462\n",
      "\n",
      "Generating signal for tsx_qtd_<lambda>:\n",
      "Signal True values: 3639\n",
      "Signal False values: 1854\n",
      "\n",
      "Generating signal for tsx_ytd_<lambda>:\n",
      "Signal True values: 3925\n",
      "Signal False values: 1568\n",
      "\n",
      "Generating negative signals...\n",
      "\n",
      "Generating signal for cad_oas_3m_<lambda>:\n",
      "Signal True values: 2955\n",
      "Signal False values: 2538\n",
      "\n",
      "Generating signal for cad_oas_1yr_<lambda>:\n",
      "Signal True values: 2949\n",
      "Signal False values: 2544\n",
      "\n",
      "Generating signal for cad_oas_qtd_<lambda>:\n",
      "Signal True values: 3056\n",
      "Signal False values: 2437\n",
      "\n",
      "Generating signal for cad_oas_ytd_<lambda>:\n",
      "Signal True values: 3324\n",
      "Signal False values: 2169\n",
      "\n",
      "Generating signal for us_hy_oas_3m_<lambda>:\n",
      "Signal True values: 3372\n",
      "Signal False values: 2121\n",
      "\n",
      "Generating signal for us_hy_oas_1yr_<lambda>:\n",
      "Signal True values: 3249\n",
      "Signal False values: 2244\n",
      "\n",
      "Generating signal for us_hy_oas_qtd_<lambda>:\n",
      "Signal True values: 3498\n",
      "Signal False values: 1995\n",
      "\n",
      "Generating signal for us_hy_oas_ytd_<lambda>:\n",
      "Signal True values: 3493\n",
      "Signal False values: 2000\n",
      "\n",
      "Generating signal for us_ig_oas_3m_<lambda>:\n",
      "Signal True values: 3253\n",
      "Signal False values: 2240\n",
      "\n",
      "Generating signal for us_ig_oas_1yr_<lambda>:\n",
      "Signal True values: 3091\n",
      "Signal False values: 2402\n",
      "\n",
      "Generating signal for us_ig_oas_qtd_<lambda>:\n",
      "Signal True values: 3494\n",
      "Signal False values: 1999\n",
      "\n",
      "Generating signal for us_ig_oas_ytd_<lambda>:\n",
      "Signal True values: 3281\n",
      "Signal False values: 2212\n",
      "\n",
      "Generating signal for vix_3m_<lambda>:\n",
      "Signal True values: 3134\n",
      "Signal False values: 2359\n",
      "\n",
      "Generating signal for vix_1yr_<lambda>:\n",
      "Signal True values: 3031\n",
      "Signal False values: 2462\n",
      "\n",
      "Generating signal for vix_qtd_<lambda>:\n",
      "Signal True values: 3142\n",
      "Signal False values: 2351\n",
      "\n",
      "Generating signal for vix_ytd_<lambda>:\n",
      "Signal True values: 3160\n",
      "Signal False values: 2333\n",
      "\n",
      "Signal Generation Summary:\n",
      "Number of signals generated: 32\n",
      "Signal array shape: (32, 5493)\n",
      "\n",
      "Starting genetic algorithm optimization...\n",
      "Generation 0: Best Fitness = 0.8561, Overall Best = 0.8561\n",
      "Found good solution at generation 0\n",
      "\n",
      "Optimization completed.\n",
      "\n",
      "Processing portfolios...\n",
      "\n",
      "Processed Combined:us_ig_oas_1yr_<lambda>:cad_oas_1yr_<lambda>:us_ig_er_index_1yr_<lambda>:OR:OR:\n",
      "Total Return: 33.36%\n",
      "Sharpe Ratio: 2.02\n",
      "Max Drawdown: -2.40%\n",
      "\n",
      "Processed Combined:cad_ig_er_index_1yr_<lambda>:us_hy_oas_ytd_<lambda>:OR:\n",
      "Total Return: 52.13%\n",
      "Sharpe Ratio: 2.14\n",
      "Max Drawdown: -3.93%\n",
      "\n",
      "Processed Combined:us_ig_er_index_3m_<lambda>:tsx_1yr_<lambda>:vix_qtd_<lambda>:us_hy_oas_qtd_<lambda>:OR:OR:AND:\n",
      "Total Return: 77.21%\n",
      "Sharpe Ratio: 3.73\n",
      "Max Drawdown: -1.35%\n",
      "\n",
      "Processed Combined:vix_ytd_<lambda>:us_ig_er_index_ytd_<lambda>:us_ig_oas_3m_<lambda>:cad_oas_ytd_<lambda>:us_ig_oas_1yr_<lambda>:tsx_1yr_<lambda>:us_ig_er_index_qtd_<lambda>:cad_ig_er_index_3m_<lambda>:tsx_3m_<lambda>:us_hy_er_index_qtd_<lambda>:vix_1yr_<lambda>:cad_oas_qtd_<lambda>:AND:AND:AND:AND:AND:AND:AND:OR:AND:OR:AND:\n",
      "Total Return: 41.02%\n",
      "Sharpe Ratio: 3.16\n",
      "Max Drawdown: -1.38%\n",
      "\n",
      "Processed Combined:us_hy_er_index_1yr_<lambda>:us_ig_er_index_3m_<lambda>:us_ig_er_index_1yr_<lambda>:us_hy_oas_1yr_<lambda>:cad_oas_qtd_<lambda>:cad_ig_er_index_qtd_<lambda>:us_hy_er_index_ytd_<lambda>:cad_ig_er_index_1yr_<lambda>:us_ig_er_index_qtd_<lambda>:us_hy_er_index_qtd_<lambda>:vix_1yr_<lambda>:cad_oas_1yr_<lambda>:AND:AND:AND:AND:AND:AND:OR:OR:AND:AND:OR:\n",
      "Total Return: 38.38%\n",
      "Sharpe Ratio: 2.63\n",
      "Max Drawdown: -1.81%\n",
      "\n",
      "Processed Combined:cad_oas_qtd_<lambda>:us_ig_er_index_qtd_<lambda>:cad_ig_er_index_3m_<lambda>:us_hy_er_index_3m_<lambda>:OR:AND:OR:\n",
      "Total Return: 75.40%\n",
      "Sharpe Ratio: 3.19\n",
      "Max Drawdown: -2.11%\n",
      "\n",
      "Processed Combined:us_hy_er_index_1yr_<lambda>:us_ig_oas_qtd_<lambda>:us_hy_oas_qtd_<lambda>:cad_ig_er_index_ytd_<lambda>:vix_qtd_<lambda>:us_hy_er_index_3m_<lambda>:us_hy_oas_1yr_<lambda>:tsx_qtd_<lambda>:us_ig_oas_ytd_<lambda>:cad_oas_qtd_<lambda>:tsx_ytd_<lambda>:OR:AND:OR:OR:AND:AND:AND:AND:OR:OR:\n",
      "Total Return: 83.20%\n",
      "Sharpe Ratio: 3.24\n",
      "Max Drawdown: -1.84%\n",
      "\n",
      "Processed Combined:us_ig_er_index_ytd_<lambda>:us_ig_er_index_3m_<lambda>:us_ig_oas_1yr_<lambda>:cad_ig_er_index_ytd_<lambda>:vix_qtd_<lambda>:us_hy_er_index_ytd_<lambda>:cad_ig_er_index_3m_<lambda>:tsx_3m_<lambda>:us_hy_er_index_qtd_<lambda>:vix_3m_<lambda>:vix_1yr_<lambda>:us_ig_oas_3m_<lambda>:us_hy_oas_3m_<lambda>:us_hy_oas_ytd_<lambda>:AND:AND:OR:AND:OR:AND:AND:OR:AND:AND:AND:AND:AND:\n",
      "Total Return: 22.54%\n",
      "Sharpe Ratio: 2.87\n",
      "Max Drawdown: -0.42%\n",
      "\n",
      "Processed Combined:cad_oas_3m_<lambda>:cad_oas_qtd_<lambda>:us_ig_oas_1yr_<lambda>:cad_ig_er_index_1yr_<lambda>:AND:AND:AND:\n",
      "Total Return: 24.78%\n",
      "Sharpe Ratio: 2.59\n",
      "Max Drawdown: -0.90%\n",
      "\n",
      "Processed Combined:cad_oas_1yr_<lambda>:us_ig_er_index_qtd_<lambda>:OR:\n",
      "Total Return: 75.62%\n",
      "Sharpe Ratio: 2.98\n",
      "Max Drawdown: -2.40%\n",
      "\n",
      "Processed Combined:us_hy_oas_1yr_<lambda>:tsx_ytd_<lambda>:cad_ig_er_index_3m_<lambda>:us_hy_er_index_3m_<lambda>:AND:AND:OR:\n",
      "Total Return: 53.95%\n",
      "Sharpe Ratio: 2.86\n",
      "Max Drawdown: -2.40%\n",
      "\n",
      "Processed Combined:tsx_qtd_<lambda>:vix_qtd_<lambda>:cad_ig_er_index_3m_<lambda>:tsx_3m_<lambda>:OR:OR:AND:\n",
      "Total Return: 76.14%\n",
      "Sharpe Ratio: 3.67\n",
      "Max Drawdown: -1.35%\n",
      "\n",
      "Processed Combined:us_ig_er_index_1yr_<lambda>:us_hy_oas_qtd_<lambda>:cad_ig_er_index_qtd_<lambda>:us_ig_er_index_qtd_<lambda>:tsx_3m_<lambda>:cad_ig_er_index_1yr_<lambda>:vix_1yr_<lambda>:tsx_qtd_<lambda>:AND:OR:AND:OR:AND:AND:OR:\n",
      "Total Return: 66.99%\n",
      "Sharpe Ratio: 3.37\n",
      "Max Drawdown: -1.67%\n",
      "\n",
      "Processed Combined:cad_oas_3m_<lambda>:us_ig_er_index_ytd_<lambda>:us_ig_oas_3m_<lambda>:us_ig_oas_qtd_<lambda>:us_ig_oas_1yr_<lambda>:cad_ig_er_index_ytd_<lambda>:cad_ig_er_index_qtd_<lambda>:us_hy_er_index_ytd_<lambda>:cad_ig_er_index_3m_<lambda>:us_ig_er_index_qtd_<lambda>:tsx_3m_<lambda>:tsx_qtd_<lambda>:us_ig_oas_ytd_<lambda>:vix_qtd_<lambda>:cad_oas_1yr_<lambda>:AND:AND:OR:AND:AND:AND:AND:OR:AND:OR:AND:AND:OR:AND:\n",
      "Total Return: 52.01%\n",
      "Sharpe Ratio: 3.53\n",
      "Max Drawdown: -1.03%\n",
      "\n",
      "Processed Combined:us_hy_er_index_3m_<lambda>:us_hy_er_index_1yr_<lambda>:tsx_1yr_<lambda>:tsx_3m_<lambda>:cad_ig_er_index_3m_<lambda>:us_ig_er_index_3m_<lambda>:cad_oas_1yr_<lambda>:tsx_ytd_<lambda>:AND:OR:AND:AND:AND:AND:AND:\n",
      "Total Return: 21.15%\n",
      "Sharpe Ratio: 2.29\n",
      "Max Drawdown: -1.76%\n",
      "\n",
      "Processed Combined:cad_oas_ytd_<lambda>:us_ig_er_index_1yr_<lambda>:us_hy_oas_ytd_<lambda>:AND:AND:\n",
      "Total Return: 31.71%\n",
      "Sharpe Ratio: 2.79\n",
      "Max Drawdown: -1.22%\n",
      "\n",
      "Processed Combined:us_hy_er_index_qtd_<lambda>:us_ig_er_index_qtd_<lambda>:OR:\n",
      "Total Return: 84.23%\n",
      "Sharpe Ratio: 3.33\n",
      "Max Drawdown: -1.84%\n",
      "\n",
      "Processed Combined:vix_ytd_<lambda>:us_hy_er_index_1yr_<lambda>:cad_oas_1yr_<lambda>:OR:OR:\n",
      "Total Return: 53.32%\n",
      "Sharpe Ratio: 2.37\n",
      "Max Drawdown: -2.40%\n",
      "\n",
      "Processed Combined:cad_oas_ytd_<lambda>:us_ig_oas_qtd_<lambda>:OR:\n",
      "Total Return: 80.05%\n",
      "Sharpe Ratio: 3.16\n",
      "Max Drawdown: -1.84%\n",
      "\n",
      "Processed Combined:vix_1yr_<lambda>:us_hy_er_index_ytd_<lambda>:AND:\n",
      "Total Return: 37.70%\n",
      "Sharpe Ratio: 2.87\n",
      "Max Drawdown: -1.59%\n",
      "\n",
      "Processed Combined:us_ig_er_index_ytd_<lambda>:us_ig_er_index_1yr_<lambda>:us_hy_er_index_ytd_<lambda>:tsx_qtd_<lambda>:us_hy_oas_ytd_<lambda>:AND:OR:AND:AND:\n",
      "Total Return: 54.74%\n",
      "Sharpe Ratio: 3.35\n",
      "Max Drawdown: -0.86%\n",
      "\n",
      "Processed Combined:vix_qtd_<lambda>:cad_oas_1yr_<lambda>:vix_ytd_<lambda>:AND:AND:\n",
      "Total Return: 23.40%\n",
      "Sharpe Ratio: 2.66\n",
      "Max Drawdown: -0.98%\n",
      "\n",
      "Processed Combined:vix_qtd_<lambda>:cad_oas_ytd_<lambda>:us_ig_er_index_ytd_<lambda>:vix_ytd_<lambda>:OR:OR:AND:\n",
      "Total Return: 60.84%\n",
      "Sharpe Ratio: 3.48\n",
      "Max Drawdown: -1.60%\n",
      "\n",
      "Processed Combined:us_hy_er_index_qtd_<lambda>:cad_ig_er_index_qtd_<lambda>:OR:\n",
      "Total Return: 80.43%\n",
      "Sharpe Ratio: 3.15\n",
      "Max Drawdown: -1.84%\n",
      "\n",
      "Processed Combined:us_hy_er_index_1yr_<lambda>:us_ig_er_index_1yr_<lambda>:us_ig_oas_1yr_<lambda>:us_hy_oas_qtd_<lambda>:cad_ig_er_index_ytd_<lambda>:us_ig_er_index_qtd_<lambda>:tsx_3m_<lambda>:us_hy_er_index_qtd_<lambda>:us_ig_oas_ytd_<lambda>:us_hy_oas_3m_<lambda>:AND:OR:AND:AND:AND:AND:AND:AND:AND:\n",
      "Total Return: 21.43%\n",
      "Sharpe Ratio: 2.30\n",
      "Max Drawdown: -1.79%\n",
      "\n",
      "Processed Combined:us_hy_er_index_1yr_<lambda>:cad_ig_er_index_qtd_<lambda>:us_hy_oas_3m_<lambda>:AND:OR:\n",
      "Total Return: 63.38%\n",
      "Sharpe Ratio: 3.04\n",
      "Max Drawdown: -1.84%\n",
      "\n",
      "Processed Combined:us_hy_oas_1yr_<lambda>:cad_oas_qtd_<lambda>:us_ig_er_index_1yr_<lambda>:us_ig_oas_1yr_<lambda>:AND:AND:AND:\n",
      "Total Return: 23.34%\n",
      "Sharpe Ratio: 2.45\n",
      "Max Drawdown: -1.57%\n",
      "\n",
      "Processed Combined:us_ig_oas_1yr_<lambda>:cad_ig_er_index_qtd_<lambda>:us_ig_er_index_1yr_<lambda>:tsx_3m_<lambda>:OR:OR:AND:\n",
      "Total Return: 32.84%\n",
      "Sharpe Ratio: 2.28\n",
      "Max Drawdown: -2.40%\n",
      "\n",
      "Processed Combined:us_hy_er_index_1yr_<lambda>:cad_oas_ytd_<lambda>:cad_ig_er_index_ytd_<lambda>:cad_ig_er_index_qtd_<lambda>:vix_qtd_<lambda>:cad_ig_er_index_1yr_<lambda>:us_hy_er_index_3m_<lambda>:us_ig_er_index_3m_<lambda>:tsx_qtd_<lambda>:us_ig_oas_ytd_<lambda>:cad_oas_qtd_<lambda>:AND:AND:OR:OR:OR:AND:AND:AND:AND:OR:\n",
      "Total Return: 84.75%\n",
      "Sharpe Ratio: 3.65\n",
      "Max Drawdown: -1.76%\n",
      "\n",
      "Processed Combined:us_hy_oas_1yr_<lambda>:us_ig_oas_1yr_<lambda>:AND:\n",
      "Total Return: 29.57%\n",
      "Sharpe Ratio: 2.18\n",
      "Max Drawdown: -2.40%\n",
      "\n",
      "Processed Combined:vix_ytd_<lambda>:us_hy_er_index_1yr_<lambda>:us_ig_oas_1yr_<lambda>:us_hy_oas_1yr_<lambda>:us_ig_er_index_qtd_<lambda>:us_hy_er_index_qtd_<lambda>:cad_oas_qtd_<lambda>:us_hy_oas_3m_<lambda>:us_hy_oas_ytd_<lambda>:AND:AND:AND:OR:AND:AND:AND:AND:\n",
      "Total Return: 25.46%\n",
      "Sharpe Ratio: 2.76\n",
      "Max Drawdown: -0.92%\n",
      "\n",
      "Processed Combined:us_hy_er_index_qtd_<lambda>:us_hy_er_index_1yr_<lambda>:us_hy_oas_3m_<lambda>:AND:AND:\n",
      "Total Return: 32.45%\n",
      "Sharpe Ratio: 2.82\n",
      "Max Drawdown: -1.68%\n",
      "\n",
      "Processed Combined:vix_qtd_<lambda>:cad_oas_ytd_<lambda>:us_ig_oas_3m_<lambda>:OR:OR:\n",
      "Total Return: 79.98%\n",
      "Sharpe Ratio: 3.07\n",
      "Max Drawdown: -2.15%\n",
      "\n",
      "Processed Combined:us_hy_er_index_qtd_<lambda>:cad_ig_er_index_ytd_<lambda>:AND:\n",
      "Total Return: 62.41%\n",
      "Sharpe Ratio: 3.16\n",
      "Max Drawdown: -1.84%\n",
      "\n",
      "Processed Combined:us_hy_er_index_1yr_<lambda>:us_ig_er_index_ytd_<lambda>:us_ig_oas_qtd_<lambda>:tsx_1yr_<lambda>:us_hy_oas_qtd_<lambda>:cad_ig_er_index_1yr_<lambda>:tsx_3m_<lambda>:us_ig_er_index_3m_<lambda>:vix_3m_<lambda>:cad_oas_qtd_<lambda>:OR:AND:AND:AND:OR:OR:AND:OR:AND:\n",
      "Total Return: 66.28%\n",
      "Sharpe Ratio: 3.46\n",
      "Max Drawdown: -1.89%\n",
      "\n",
      "Processed Combined:tsx_1yr_<lambda>:us_hy_oas_qtd_<lambda>:us_hy_er_index_qtd_<lambda>:vix_3m_<lambda>:cad_oas_qtd_<lambda>:AND:AND:AND:OR:\n",
      "Total Return: 74.42%\n",
      "Sharpe Ratio: 3.42\n",
      "Max Drawdown: -1.84%\n",
      "\n",
      "Processed Combined:tsx_1yr_<lambda>:us_ig_er_index_1yr_<lambda>:AND:\n",
      "Total Return: 26.94%\n",
      "Sharpe Ratio: 1.81\n",
      "Max Drawdown: -2.40%\n",
      "\n",
      "Processed Combined:tsx_qtd_<lambda>:cad_oas_1yr_<lambda>:us_hy_er_index_ytd_<lambda>:vix_qtd_<lambda>:OR:OR:AND:\n",
      "Total Return: 79.62%\n",
      "Sharpe Ratio: 3.77\n",
      "Max Drawdown: -1.37%\n",
      "\n",
      "Processed Combined:cad_oas_3m_<lambda>:vix_qtd_<lambda>:AND:\n",
      "Total Return: 47.23%\n",
      "Sharpe Ratio: 3.29\n",
      "Max Drawdown: -0.83%\n",
      "\n",
      "Processed Combined:us_hy_er_index_qtd_<lambda>:us_ig_oas_ytd_<lambda>:vix_qtd_<lambda>:us_hy_er_index_ytd_<lambda>:AND:OR:OR:\n",
      "Total Return: 80.61%\n",
      "Sharpe Ratio: 3.11\n",
      "Max Drawdown: -2.14%\n",
      "\n",
      "Processed Combined:cad_oas_1yr_<lambda>:cad_ig_er_index_3m_<lambda>:OR:\n",
      "Total Return: 53.45%\n",
      "Sharpe Ratio: 2.57\n",
      "Max Drawdown: -2.42%\n",
      "\n",
      "Processed Combined:us_ig_oas_qtd_<lambda>:tsx_3m_<lambda>:OR:\n",
      "Total Return: 85.61%\n",
      "Sharpe Ratio: 3.31\n",
      "Max Drawdown: -3.07%\n",
      "\n",
      "Processed Combined:cad_oas_ytd_<lambda>:vix_qtd_<lambda>:AND:\n",
      "Total Return: 51.23%\n",
      "Sharpe Ratio: 3.66\n",
      "Max Drawdown: -0.68%\n",
      "\n",
      "Processed Combined:us_hy_er_index_1yr_<lambda>:cad_oas_1yr_<lambda>:cad_ig_er_index_1yr_<lambda>:us_hy_oas_ytd_<lambda>:OR:OR:AND:\n",
      "Total Return: 36.68%\n",
      "Sharpe Ratio: 2.61\n",
      "Max Drawdown: -1.56%\n",
      "\n",
      "Processed Combined:cad_oas_1yr_<lambda>:us_ig_er_index_qtd_<lambda>:tsx_ytd_<lambda>:AND:AND:\n",
      "Total Return: 26.38%\n",
      "Sharpe Ratio: 2.56\n",
      "Max Drawdown: -1.58%\n",
      "\n",
      "Processed Combined:tsx_qtd_<lambda>:cad_oas_ytd_<lambda>:OR:\n",
      "Total Return: 83.74%\n",
      "Sharpe Ratio: 3.22\n",
      "Max Drawdown: -2.39%\n",
      "\n",
      "Processed Combined:cad_oas_3m_<lambda>:us_hy_oas_3m_<lambda>:us_ig_er_index_ytd_<lambda>:us_ig_oas_3m_<lambda>:cad_oas_ytd_<lambda>:us_ig_er_index_1yr_<lambda>:us_hy_oas_qtd_<lambda>:us_ig_er_index_qtd_<lambda>:us_hy_er_index_qtd_<lambda>:vix_3m_<lambda>:us_ig_oas_ytd_<lambda>:cad_oas_1yr_<lambda>:tsx_ytd_<lambda>:OR:OR:OR:AND:AND:AND:OR:OR:AND:OR:AND:AND:\n",
      "Total Return: 52.33%\n",
      "Sharpe Ratio: 3.19\n",
      "Max Drawdown: -1.84%\n",
      "\n",
      "Processed Combined:us_ig_oas_3m_<lambda>:us_ig_oas_qtd_<lambda>:us_ig_er_index_1yr_<lambda>:us_ig_oas_1yr_<lambda>:cad_ig_er_index_qtd_<lambda>:vix_1yr_<lambda>:cad_ig_er_index_1yr_<lambda>:tsx_3m_<lambda>:us_hy_oas_1yr_<lambda>:vix_qtd_<lambda>:cad_oas_qtd_<lambda>:us_hy_oas_ytd_<lambda>:AND:OR:AND:AND:OR:OR:OR:AND:AND:AND:AND:\n",
      "Total Return: 24.23%\n",
      "Sharpe Ratio: 2.79\n",
      "Max Drawdown: -0.50%\n",
      "\n",
      "Processed Combined:tsx_1yr_<lambda>:us_ig_oas_qtd_<lambda>:cad_ig_er_index_3m_<lambda>:AND:AND:\n",
      "Total Return: 30.61%\n",
      "Sharpe Ratio: 2.81\n",
      "Max Drawdown: -1.53%\n",
      "\n",
      "Top 10 Strategies Overall:\n",
      "                                             Strategy  Total_Return_%  \\\n",
      "41  Combined:us_ig_oas_qtd_<lambda>:tsx_3m_<lambda...       85.610911   \n",
      "28  Combined:us_hy_er_index_1yr_<lambda>:cad_oas_y...       84.754380   \n",
      "16  Combined:us_hy_er_index_qtd_<lambda>:us_ig_er_...       84.230494   \n",
      "45  Combined:tsx_qtd_<lambda>:cad_oas_ytd_<lambda>:OR       83.739714   \n",
      "6   Combined:us_hy_er_index_1yr_<lambda>:us_ig_oas...       83.199895   \n",
      "39  Combined:us_hy_er_index_qtd_<lambda>:us_ig_oas...       80.608781   \n",
      "23  Combined:us_hy_er_index_qtd_<lambda>:cad_ig_er...       80.425511   \n",
      "18  Combined:cad_oas_ytd_<lambda>:us_ig_oas_qtd_<l...       80.052353   \n",
      "32  Combined:vix_qtd_<lambda>:cad_oas_ytd_<lambda>...       79.976681   \n",
      "37  Combined:tsx_qtd_<lambda>:cad_oas_1yr_<lambda>...       79.617061   \n",
      "\n",
      "    Sharpe_Ratio  Max_Drawdown_%  \n",
      "41      3.306717       -3.073042  \n",
      "28      3.653024       -1.755565  \n",
      "16      3.331308       -1.839838  \n",
      "45      3.220702       -2.390961  \n",
      "6       3.235135       -1.839838  \n",
      "39      3.110704       -2.139842  \n",
      "23      3.152169       -1.839838  \n",
      "18      3.158644       -1.839838  \n",
      "32      3.068866       -2.153860  \n",
      "37      3.765783       -1.368984  \n",
      "\n",
      "Best Strategy: Combined:us_ig_oas_qtd_<lambda>:tsx_3m_<lambda>:OR\n",
      "\n",
      "Best Strategy Performance:\n",
      "Total Return: 85.61%\n",
      "Sharpe Ratio: 3.31\n",
      "Max Drawdown: -3.07%\n",
      "\n",
      "Buy & Hold Performance:\n",
      "Total Return: 31.83%\n",
      "Sharpe Ratio: 1.03\n",
      "Max Drawdown: -15.48%\n",
      "\n",
      "Best Strategy Signal Composition:\n",
      "Signals used: ['tsx_3m_<lambda>', 'us_ig_oas_qtd_<lambda>']\n"
     ]
    }
   ],
   "source": [
    "import vectorbt as vbt\n",
    "from vectorbt.portfolio.enums import SizeType\n",
    "import pandas as pd\n",
    "import numpy as np\n",
    "from deap import base, creator, tools, algorithms\n",
    "import random\n",
    "import warnings\n",
    "warnings.filterwarnings('ignore')\n",
    "\n",
    "# Clear any existing DEAP types\n",
    "if 'FitnessMax' in creator.__dict__:\n",
    "    del creator.FitnessMax\n",
    "if 'Individual' in creator.__dict__:\n",
    "    del creator.Individual\n",
    "\n",
    "# Define our indicators and their types\n",
    "positive_indicators = ['cad_ig_er_index', 'us_hy_er_index', 'us_ig_er_index', 'tsx']\n",
    "negative_indicators = ['cad_oas', 'us_hy_oas', 'us_ig_oas', 'vix']\n",
    "intervals = ['3m', '1yr', 'qtd', 'ytd']\n",
    "\n",
    "# Print data information\n",
    "print(\"\\nData Overview:\")\n",
    "print(f\"final_df shape: {final_df.shape}\")\n",
    "print(f\"final_df columns: {final_df.columns.tolist()}\")\n",
    "print(f\"final_df index: {final_df.index[0]} to {final_df.index[-1]}\")\n",
    "\n",
    "# Vectorized signal generation\n",
    "def generate_signals(indicators, intervals, final_df, condition_func):\n",
    "    signals = {}\n",
    "    for indicator in indicators:\n",
    "        for interval in intervals:\n",
    "            col_name = f'{indicator}_{interval}'\n",
    "            if col_name not in final_df.columns:\n",
    "                print(f\"Warning: Column {col_name} not found in DataFrame\")\n",
    "                continue\n",
    "                \n",
    "            signal_name = f'{indicator}_{interval}_{condition_func.__name__}'\n",
    "            signal_value = condition_func(final_df[col_name])\n",
    "            signals[signal_name] = signal_value\n",
    "            \n",
    "            print(f\"\\nGenerating signal for {signal_name}:\")\n",
    "            print(f\"Signal True values: {signal_value.sum()}\")\n",
    "            print(f\"Signal False values: {(~signal_value).sum()}\")\n",
    "    return signals\n",
    "\n",
    "# Generate signals using vectorized operations\n",
    "print(\"\\nGenerating positive signals...\")\n",
    "positive_signals = generate_signals(positive_indicators, intervals, final_df, lambda x: x > 0)\n",
    "print(\"\\nGenerating negative signals...\")\n",
    "negative_signals = generate_signals(negative_indicators, intervals, final_df, lambda x: x < 0)\n",
    "signal_dict = {**positive_signals, **negative_signals}\n",
    "\n",
    "# Convert to numpy arrays for faster operations\n",
    "signal_names = list(signal_dict.keys())\n",
    "signals = np.array([signal_dict[name].values for name in signal_names])\n",
    "\n",
    "print(\"\\nSignal Generation Summary:\")\n",
    "print(f\"Number of signals generated: {len(signal_names)}\")\n",
    "print(f\"Signal array shape: {signals.shape}\")\n",
    "\n",
    "# Dictionary to store all portfolios\n",
    "all_portfolios = {}\n",
    "\n",
    "def evaluate(individual):\n",
    "    used_signals = set()\n",
    "    operations = []\n",
    "    combined_signal = None\n",
    "    \n",
    "    # Count active signals for debugging\n",
    "    active_signals = sum(1 for i in range(len(signals)) if individual[i * 2])\n",
    "    if active_signals < 2:\n",
    "        return -np.inf,\n",
    "    \n",
    "    for i in range(len(signals)):\n",
    "        if individual[i * 2]:  # If signal is used\n",
    "            signal = signals[i]\n",
    "            signal_name = signal_names[i]\n",
    "            \n",
    "            if signal_name in used_signals:\n",
    "                continue\n",
    "                \n",
    "            used_signals.add(signal_name)\n",
    "            \n",
    "            if combined_signal is None:\n",
    "                combined_signal = signal\n",
    "            else:\n",
    "                op_idx = i * 2 - 1\n",
    "                if op_idx < len(individual):\n",
    "                    operation = \"OR\" if individual[op_idx] else \"AND\"\n",
    "                    operations.append(operation)\n",
    "                    \n",
    "                    if operation == \"OR\":\n",
    "                        combined_signal = combined_signal | signal\n",
    "                    else:\n",
    "                        combined_signal = combined_signal & signal\n",
    "    \n",
    "    if combined_signal is None or len(used_signals) < 2:\n",
    "        return -np.inf,\n",
    "    \n",
    "    try:\n",
    "        # Convert combined signal to pandas Series with proper index\n",
    "        combined_signal = pd.Series(combined_signal, index=final_df.index)\n",
    "        \n",
    "        # Create portfolio\n",
    "        pf = vbt.Portfolio.from_signals(\n",
    "            close=final_df['cad_ig_er_index'],\n",
    "            entries=combined_signal,\n",
    "            exits=~combined_signal,\n",
    "            freq='1D',\n",
    "            init_cash=100000,\n",
    "            size=1.0,\n",
    "            size_type=SizeType.Percent,\n",
    "            accumulate=False\n",
    "        )\n",
    "        \n",
    "        # Calculate total return\n",
    "        total_return = pf.total_return()\n",
    "        \n",
    "        if not np.isfinite(total_return):\n",
    "            return -np.inf,\n",
    "            \n",
    "        # Store successful portfolio\n",
    "        strategy_key = \"Combined:\" + \":\".join(used_signals)\n",
    "        operations_str = \":\".join(operations)\n",
    "        key = f\"{strategy_key}:{operations_str}\"\n",
    "        all_portfolios[key] = pf\n",
    "        \n",
    "        return float(total_return),\n",
    "        \n",
    "    except Exception as e:\n",
    "        print(f\"Error in evaluate function: {str(e)}\")\n",
    "        return -np.inf,\n",
    "\n",
    "# Genetic Algorithm Setup\n",
    "creator.create(\"FitnessMax\", base.Fitness, weights=(1.0,))\n",
    "creator.create(\"Individual\", list, fitness=creator.FitnessMax)\n",
    "\n",
    "def create_diverse_individual():\n",
    "    ind = [0] * n_bits\n",
    "    n_signals_to_use = random.randint(2, 4)\n",
    "    signal_positions = random.sample(range(n_signals), n_signals_to_use)\n",
    "    \n",
    "    for pos in signal_positions:\n",
    "        ind[pos * 2] = 1\n",
    "        if pos > 0:\n",
    "            ind[pos * 2 - 1] = random.randint(0, 1)\n",
    "    \n",
    "    return creator.Individual(ind)\n",
    "\n",
    "# Initialize genetic algorithm\n",
    "toolbox = base.Toolbox()\n",
    "n_signals = len(signals)\n",
    "n_bits = 2 * n_signals - 1\n",
    "\n",
    "toolbox.register(\"individual\", create_diverse_individual)\n",
    "toolbox.register(\"population\", tools.initRepeat, list, toolbox.individual)\n",
    "toolbox.register(\"evaluate\", evaluate)\n",
    "toolbox.register(\"mate\", tools.cxTwoPoint)\n",
    "toolbox.register(\"mutate\", tools.mutFlipBit, indpb=0.3)  # Increased mutation rate\n",
    "toolbox.register(\"select\", tools.selTournament, tournsize=3)\n",
    "\n",
    "# GA Parameters\n",
    "POPULATION_SIZE = 50\n",
    "MAX_GENERATIONS = 30\n",
    "HALL_OF_FAME_SIZE = 10\n",
    "\n",
    "# Create hall of fame\n",
    "hall_of_fame = tools.HallOfFame(HALL_OF_FAME_SIZE)\n",
    "\n",
    "# Initialize population\n",
    "population = toolbox.population(n=POPULATION_SIZE)\n",
    "\n",
    "# Run genetic algorithm\n",
    "print(\"\\nStarting genetic algorithm optimization...\")\n",
    "best_fitness = -np.inf\n",
    "best_individual = None\n",
    "\n",
    "for gen in range(MAX_GENERATIONS):\n",
    "    # Generate offspring\n",
    "    offspring = algorithms.varAnd(population, toolbox, cxpb=0.7, mutpb=0.3)\n",
    "    \n",
    "    # Evaluate individuals\n",
    "    fits = map(toolbox.evaluate, offspring)\n",
    "    for fit, ind in zip(fits, offspring):\n",
    "        ind.fitness.values = fit\n",
    "        \n",
    "        # Update best individual\n",
    "        if fit[0] > best_fitness:\n",
    "            best_fitness = fit[0]\n",
    "            best_individual = ind.copy()\n",
    "    \n",
    "    # Select next generation\n",
    "    population = toolbox.select(offspring, len(population))\n",
    "    \n",
    "    # Update hall of fame\n",
    "    hall_of_fame.update(population)\n",
    "    \n",
    "    # Print progress\n",
    "    gen_fits = [ind.fitness.values[0] for ind in population]\n",
    "    gen_best = max(gen_fits)\n",
    "    print(f\"Generation {gen}: Best Fitness = {gen_best:.4f}, Overall Best = {best_fitness:.4f}\")\n",
    "    \n",
    "    # Early stopping if we find a good solution\n",
    "    if best_fitness > 0.5:  # 50% return\n",
    "        print(f\"Found good solution at generation {gen}\")\n",
    "        break\n",
    "\n",
    "print(\"\\nOptimization completed.\")\n",
    "\n",
    "# Process results\n",
    "if all_portfolios:\n",
    "    # Create results DataFrame with debugging\n",
    "    all_results = []\n",
    "    print(\"\\nProcessing portfolios...\")\n",
    "    \n",
    "    for name, pf in all_portfolios.items():\n",
    "        try:\n",
    "            # Get metrics with percentage formatting\n",
    "            total_return = float(pf.total_return()) * 100  # Convert to percentage\n",
    "            sharpe = float(pf.sharpe_ratio())\n",
    "            max_dd = float(pf.max_drawdown()) * 100  # Convert to percentage\n",
    "            \n",
    "            result = {\n",
    "                'Strategy': name,\n",
    "                'Total_Return_%': total_return,\n",
    "                'Sharpe_Ratio': sharpe,\n",
    "                'Max_Drawdown_%': max_dd\n",
    "            }\n",
    "            \n",
    "            print(f\"\\nProcessed {name}:\")\n",
    "            print(f\"Total Return: {total_return:.2f}%\")\n",
    "            print(f\"Sharpe Ratio: {sharpe:.2f}\")\n",
    "            print(f\"Max Drawdown: {max_dd:.2f}%\")\n",
    "            \n",
    "            all_results.append(result)\n",
    "            \n",
    "        except Exception as e:\n",
    "            print(f\"Error processing portfolio {name}: {str(e)}\")\n",
    "            continue\n",
    "\n",
    "    if all_results:\n",
    "        # Create and sort results DataFrame\n",
    "        results_df = pd.DataFrame(all_results)\n",
    "        results_df = results_df.sort_values('Total_Return_%', ascending=False)\n",
    "\n",
    "        print(\"\\nTop 10 Strategies Overall:\")\n",
    "        print(results_df.head(10))\n",
    "\n",
    "        # Get best strategy\n",
    "        best_strategy_name = results_df.iloc[0]['Strategy']\n",
    "        best_portfolio = all_portfolios[best_strategy_name]\n",
    "\n",
    "        # Create buy & hold portfolio for comparison\n",
    "        bh_pf = vbt.Portfolio.from_holding(\n",
    "            final_df['cad_ig_er_index'],\n",
    "            freq='1D',\n",
    "            init_cash=100000,\n",
    "            size=1.0,\n",
    "            size_type=SizeType.Percent\n",
    "        )\n",
    "\n",
    "        print(\"\\nBest Strategy:\", best_strategy_name)\n",
    "        print(\"\\nBest Strategy Performance:\")\n",
    "        print(f\"Total Return: {best_portfolio.total_return():.2%}\")\n",
    "        print(f\"Sharpe Ratio: {best_portfolio.sharpe_ratio():.2f}\")\n",
    "        print(f\"Max Drawdown: {best_portfolio.max_drawdown():.2%}\")\n",
    "\n",
    "        print(\"\\nBuy & Hold Performance:\")\n",
    "        print(f\"Total Return: {bh_pf.total_return():.2%}\")\n",
    "        print(f\"Sharpe Ratio: {bh_pf.sharpe_ratio():.2f}\")\n",
    "        print(f\"Max Drawdown: {bh_pf.max_drawdown():.2%}\")\n",
    "\n",
    "        # Save best strategy signals for analysis\n",
    "        if best_individual is not None:\n",
    "            print(\"\\nBest Strategy Signal Composition:\")\n",
    "            used_signals = []\n",
    "            for i in range(len(signals)):\n",
    "                if best_individual[i * 2]:\n",
    "                    used_signals.append(signal_names[i])\n",
    "            print(\"Signals used:\", used_signals)\n",
    "    else:\n",
    "        print(\"No valid results were processed.\")\n",
    "else:\n",
    "    print(\"No valid strategies were found.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "158bdc4683a74d67b16547509b027d5e",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "FigureWidget({\n",
       "    'data': [{'legendgroup': '0',\n",
       "              'line': {'color': '#1f77b4'},\n",
       "              'name': 'Close',\n",
       "              'showlegend': True,\n",
       "              'type': 'scatter',\n",
       "              'uid': '9cab0e24-7241-420a-bf9f-5c737b51d53a',\n",
       "              'x': array([datetime.datetime(2003, 9, 24, 0, 0),\n",
       "                          datetime.datetime(2003, 9, 25, 0, 0),\n",
       "                          datetime.datetime(2003, 9, 26, 0, 0), ...,\n",
       "                          datetime.datetime(2025, 1, 29, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 30, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 31, 0, 0)], dtype=object),\n",
       "              'xaxis': 'x',\n",
       "              'y': array([101.86880272, 101.6781237 , 101.84425379, ..., 134.2978809 ,\n",
       "                          134.29400721, 134.29400721]),\n",
       "              'yaxis': 'y'},\n",
       "             {'customdata': array([[   0.        ,  981.6548082 ,    0.        ],\n",
       "                                   [   2.        ,  982.73319429,    0.        ],\n",
       "                                   [   4.        ,  983.83629255,    0.        ],\n",
       "                                   ...,\n",
       "                                   [ 434.        , 1375.71316704,    0.        ],\n",
       "                                   [ 436.        , 1375.68618951,    0.        ],\n",
       "                                   [ 438.        , 1375.74552906,    0.        ]]),\n",
       "              'hovertemplate': ('Order Id: %{customdata[0]}<br>' ... '<br>Fees: %{customdata[2]:.6f}'),\n",
       "              'legendgroup': '1',\n",
       "              'marker': {'color': '#37B13F',\n",
       "                         'line': {'color': 'rgb(38,123,44)', 'width': 1},\n",
       "                         'size': 8,\n",
       "                         'symbol': 'triangle-up'},\n",
       "              'mode': 'markers',\n",
       "              'name': 'Buy',\n",
       "              'type': 'scatter',\n",
       "              'uid': '9fcd08d2-4acf-4944-afbb-0d9230efd179',\n",
       "              'x': array([datetime.datetime(2003, 9, 24, 0, 0),\n",
       "                          datetime.datetime(2003, 9, 30, 0, 0),\n",
       "                          datetime.datetime(2004, 3, 12, 0, 0), ...,\n",
       "                          datetime.datetime(2025, 1, 3, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 15, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 28, 0, 0)], dtype=object),\n",
       "              'xaxis': 'x',\n",
       "              'y': array([101.86880272, 101.83028837, 102.99763376, ..., 134.39158949,\n",
       "                          134.38597774, 134.33359431]),\n",
       "              'yaxis': 'y'},\n",
       "             {'customdata': array([[1.00000000e+00, 9.81654808e+02, 0.00000000e+00],\n",
       "                                   [3.00000000e+00, 9.82733194e+02, 0.00000000e+00],\n",
       "                                   [5.00000000e+00, 9.83836293e+02, 0.00000000e+00],\n",
       "                                   ...,\n",
       "                                   [4.33000000e+02, 1.37542160e+03, 0.00000000e+00],\n",
       "                                   [4.35000000e+02, 1.37571317e+03, 0.00000000e+00],\n",
       "                                   [4.37000000e+02, 1.37568619e+03, 0.00000000e+00]]),\n",
       "              'hovertemplate': ('Order Id: %{customdata[0]}<br>' ... '<br>Fees: %{customdata[2]:.6f}'),\n",
       "              'legendgroup': '2',\n",
       "              'marker': {'color': '#EA4335',\n",
       "                         'line': {'color': 'rgb(181,31,18)', 'width': 1},\n",
       "                         'size': 8,\n",
       "                         'symbol': 'triangle-down'},\n",
       "              'mode': 'markers',\n",
       "              'name': 'Sell',\n",
       "              'type': 'scatter',\n",
       "              'uid': 'a1542e8f-5dfc-442e-b70c-de26ef49a69e',\n",
       "              'x': array([datetime.datetime(2003, 9, 29, 0, 0),\n",
       "                          datetime.datetime(2004, 3, 10, 0, 0),\n",
       "                          datetime.datetime(2004, 3, 15, 0, 0), ...,\n",
       "                          datetime.datetime(2025, 1, 2, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 7, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 27, 0, 0)], dtype=object),\n",
       "              'xaxis': 'x',\n",
       "              'y': array([101.94215292, 103.11324653, 102.98780411, ..., 134.42007801,\n",
       "                          134.38334245, 134.33938872]),\n",
       "              'yaxis': 'y'},\n",
       "             {'customdata': array([[0.00000000e+00, 0.00000000e+00, 7.20045695e+01, 7.20045695e-04],\n",
       "                                   [1.00000000e+00, 1.00000000e+00, 1.26080557e+03, 1.25989839e-02],\n",
       "                                   [3.00000000e+00, 3.00000000e+00, 2.12981269e+01, 2.10200030e-04],\n",
       "                                   ...,\n",
       "                                   [2.12000000e+02, 2.12000000e+02, 3.45695709e+01, 1.89843263e-04],\n",
       "                                   [2.15000000e+02, 2.15000000e+02, 5.46388120e+02, 3.00168822e-03],\n",
       "                                   [2.16000000e+02, 2.16000000e+02, 2.31095175e+03, 1.26576635e-02]]),\n",
       "              'hovertemplate': ('Exit Trade Id: %{customdata[0]' ... 'r>Return: %{customdata[3]:.2%}'),\n",
       "              'legendgroup': '3',\n",
       "              'marker': {'color': '#37B13F',\n",
       "                         'line': {'color': 'rgb(38,123,44)', 'width': 1},\n",
       "                         'opacity': array([0.75140194, 0.77453043, 0.75040926, 0.75282873, 0.75186798, 0.75099339,\n",
       "                                           0.75013992, 0.75040555, 0.75939967, 0.757058  , 0.75029716, 0.75007519,\n",
       "                                           0.76062512, 0.75300688, 0.75009757, 0.75013357, 0.75012332, 0.7500829 ,\n",
       "                                           0.75150223, 0.75197301, 0.75064264, 0.75238365, 0.75188648, 0.75066151,\n",
       "                                           0.75620966, 0.75070139, 0.75482764, 0.75009841, 0.75015438, 0.75033782,\n",
       "                                           0.76492837, 0.75034115, 0.7550369 , 0.76258625, 0.75645395, 0.75183185,\n",
       "                                           0.9       , 0.81584362, 0.77012382, 0.75173868, 0.7803754 , 0.75004191,\n",
       "                                           0.76213269, 0.78258924, 0.75615675, 0.75566323, 0.75329064, 0.75544536,\n",
       "                                           0.80643018, 0.75894535, 0.75063582, 0.75410189, 0.77528496, 0.7513804 ,\n",
       "                                           0.75342746, 0.75331583, 0.75154545, 0.75147089, 0.75251894, 0.77276946,\n",
       "                                           0.75136216, 0.75028985, 0.75135683, 0.7502113 , 0.75036775, 0.75408374,\n",
       "                                           0.75022754, 0.76644705, 0.75433634, 0.76206107, 0.75051573, 0.76099468,\n",
       "                                           0.75008271, 0.75114306, 0.7507002 , 0.75300314, 0.75074679, 0.75032717,\n",
       "                                           0.75025085, 0.76775784, 0.75149447, 0.760284  , 0.77231634, 0.7862739 ,\n",
       "                                           0.75044057, 0.75416273, 0.75074085, 0.78960165, 0.75081876, 0.75122123,\n",
       "                                           0.75121428, 0.75846531, 0.75014929, 0.75480962, 0.75048522, 0.75469765,\n",
       "                                           0.75052937, 0.77783667, 0.75034483, 0.75006208, 0.75069594, 0.76021807,\n",
       "                                           0.79460781, 0.77630533, 0.75054799, 0.75463291, 0.7507144 , 0.77852584,\n",
       "                                           0.75408304, 0.75015802, 0.87601566, 0.78127832, 0.75141706, 0.78868542,\n",
       "                                           0.75484705, 0.75043732, 0.75078649, 0.75376395, 0.75088342, 0.75808663,\n",
       "                                           0.75034511, 0.75097259, 0.75463148, 0.75467322, 0.75126598, 0.76002095,\n",
       "                                           0.7536473 , 0.76831912, 0.75069494, 0.76665357, 0.75676635, 0.75289632,\n",
       "                                           0.75252313, 0.75299137, 0.76176641, 0.75787523, 0.75034237, 0.75295181,\n",
       "                                           0.75078083, 0.77891984, 0.75441786, 0.75076526, 0.75092864, 0.7505684 ,\n",
       "                                           0.75457692, 0.75107285, 0.75057997, 0.75050426, 0.75036963, 0.75584434,\n",
       "                                           0.77464468]),\n",
       "                         'size': array([ 7.0654239 ,  8.14475325,  7.01909893,  7.13200728,  7.08717221,\n",
       "                                         7.04635815,  7.00652947,  7.0189257 ,  7.43865122,  7.32937317,\n",
       "                                         7.01386755,  7.00350879,  7.49583895,  7.14032102,  7.00455326,\n",
       "                                         7.00623332,  7.00575504,  7.00386873,  7.0701039 ,  7.09207362,\n",
       "                                         7.0299899 ,  7.11123681,  7.08803595,  7.03087058,  7.28978431,\n",
       "                                         7.03273159,  7.22528966,  7.00459238,  7.00720417,  7.01576511,\n",
       "                                         7.69665734,  7.01592012,  7.23505548,  7.58735838,  7.30118442,\n",
       "                                         7.08548611, 14.        , 10.07270245,  7.93911173,  7.0811383 ,\n",
       "                                         8.41751864,  7.00195576,  7.56619202,  8.5208313 ,  7.2873149 ,\n",
       "                                         7.26428389,  7.15356305,  7.25411698,  9.63340826,  7.4174495 ,\n",
       "                                         7.02967156,  7.19142172,  8.17996464,  7.06441862,  7.15994801,\n",
       "                                         7.15473875,  7.07212114,  7.06864157,  7.11755057,  8.0625748 ,\n",
       "                                         7.06356756,  7.01352622,  7.06331894,  7.00986084,  7.0171618 ,\n",
       "                                         7.19057443,  7.01061844,  7.76752902,  7.20236272,  7.56285015,\n",
       "                                         7.02406761,  7.51308494,  7.0038599 ,  7.05334265,  7.03267612,\n",
       "                                         7.14014646,  7.03485017,  7.01526779,  7.01170619,  7.82869933,\n",
       "                                         7.06974215,  7.47992   ,  8.04142905,  8.69278219,  7.0205598 ,\n",
       "                                         7.1942609 ,  7.03457323,  8.84807707,  7.03820873,  7.0569905 ,\n",
       "                                         7.05666645,  7.39504793,  7.00696703,  7.224449  ,  7.02264348,\n",
       "                                         7.21922363,  7.02470388,  8.29904451,  7.01609222,  7.00289721,\n",
       "                                         7.0324773 ,  7.47684325,  9.08169777,  8.22758214,  7.02557283,\n",
       "                                         7.21620268,  7.03333865,  8.33120586,  7.19054179,  7.0073743 ,\n",
       "                                        12.8807307 ,  8.45965494,  7.06612969,  8.80531977,  7.22619563,\n",
       "                                         7.02040805,  7.03670299,  7.17565095,  7.04122629,  7.37737585,\n",
       "                                         7.01610512,  7.04538765,  7.21613552,  7.21808358,  7.05907911,\n",
       "                                         7.46764437,  7.17020729,  7.85489205,  7.0324307 ,  7.77716677,\n",
       "                                         7.31576294,  7.13516179,  7.11774592,  7.13959744,  7.54909934,\n",
       "                                         7.36751074,  7.01597749,  7.13775099,  7.03643868,  8.34959234,\n",
       "                                         7.20616682,  7.03571202,  7.04333655,  7.02652534,  7.21358957,\n",
       "                                         7.05006611,  7.02706544,  7.02353232,  7.0172493 ,  7.27273567,\n",
       "                                         8.15008493]),\n",
       "                         'symbol': 'circle'},\n",
       "              'mode': 'markers',\n",
       "              'name': 'Closed - Profit',\n",
       "              'type': 'scatter',\n",
       "              'uid': '409e2fbb-d869-4acf-bbdc-4b95386e8115',\n",
       "              'x': array([datetime.datetime(2003, 9, 29, 0, 0),\n",
       "                          datetime.datetime(2004, 3, 10, 0, 0),\n",
       "                          datetime.datetime(2004, 3, 18, 0, 0),\n",
       "                          datetime.datetime(2004, 4, 13, 0, 0),\n",
       "                          datetime.datetime(2004, 4, 30, 0, 0),\n",
       "                          datetime.datetime(2004, 7, 1, 0, 0),\n",
       "                          datetime.datetime(2004, 7, 15, 0, 0),\n",
       "                          datetime.datetime(2004, 9, 15, 0, 0),\n",
       "                          datetime.datetime(2005, 1, 3, 0, 0),\n",
       "                          datetime.datetime(2005, 3, 16, 0, 0),\n",
       "                          datetime.datetime(2005, 3, 21, 0, 0),\n",
       "                          datetime.datetime(2005, 5, 6, 0, 0),\n",
       "                          datetime.datetime(2005, 7, 6, 0, 0),\n",
       "                          datetime.datetime(2005, 8, 1, 0, 0),\n",
       "                          datetime.datetime(2005, 8, 4, 0, 0),\n",
       "                          datetime.datetime(2005, 9, 19, 0, 0),\n",
       "                          datetime.datetime(2005, 10, 3, 0, 0),\n",
       "                          datetime.datetime(2005, 11, 14, 0, 0),\n",
       "                          datetime.datetime(2005, 12, 30, 0, 0),\n",
       "                          datetime.datetime(2006, 5, 12, 0, 0),\n",
       "                          datetime.datetime(2006, 7, 5, 0, 0),\n",
       "                          datetime.datetime(2006, 9, 6, 0, 0),\n",
       "                          datetime.datetime(2006, 10, 2, 0, 0),\n",
       "                          datetime.datetime(2006, 10, 5, 0, 0),\n",
       "                          datetime.datetime(2007, 1, 2, 0, 0),\n",
       "                          datetime.datetime(2007, 1, 5, 0, 0),\n",
       "                          datetime.datetime(2007, 3, 2, 0, 0),\n",
       "                          datetime.datetime(2007, 6, 20, 0, 0),\n",
       "                          datetime.datetime(2007, 10, 2, 0, 0),\n",
       "                          datetime.datetime(2008, 2, 27, 0, 0),\n",
       "                          datetime.datetime(2008, 7, 2, 0, 0),\n",
       "                          datetime.datetime(2008, 7, 28, 0, 0),\n",
       "                          datetime.datetime(2008, 9, 9, 0, 0),\n",
       "                          datetime.datetime(2009, 1, 7, 0, 0),\n",
       "                          datetime.datetime(2009, 1, 29, 0, 0),\n",
       "                          datetime.datetime(2009, 3, 27, 0, 0),\n",
       "                          datetime.datetime(2009, 7, 2, 0, 0),\n",
       "                          datetime.datetime(2009, 10, 1, 0, 0),\n",
       "                          datetime.datetime(2009, 10, 28, 0, 0),\n",
       "                          datetime.datetime(2009, 10, 30, 0, 0),\n",
       "                          datetime.datetime(2010, 1, 21, 0, 0),\n",
       "                          datetime.datetime(2010, 2, 4, 0, 0),\n",
       "                          datetime.datetime(2010, 4, 16, 0, 0),\n",
       "                          datetime.datetime(2011, 1, 20, 0, 0),\n",
       "                          datetime.datetime(2011, 1, 28, 0, 0),\n",
       "                          datetime.datetime(2011, 5, 5, 0, 0),\n",
       "                          datetime.datetime(2011, 5, 16, 0, 0),\n",
       "                          datetime.datetime(2011, 7, 11, 0, 0),\n",
       "                          datetime.datetime(2012, 4, 2, 0, 0),\n",
       "                          datetime.datetime(2012, 7, 10, 0, 0),\n",
       "                          datetime.datetime(2012, 7, 16, 0, 0),\n",
       "                          datetime.datetime(2012, 8, 2, 0, 0),\n",
       "                          datetime.datetime(2012, 10, 9, 0, 0),\n",
       "                          datetime.datetime(2012, 10, 12, 0, 0),\n",
       "                          datetime.datetime(2012, 11, 7, 0, 0),\n",
       "                          datetime.datetime(2012, 11, 27, 0, 0),\n",
       "                          datetime.datetime(2012, 11, 30, 0, 0),\n",
       "                          datetime.datetime(2012, 12, 13, 0, 0),\n",
       "                          datetime.datetime(2012, 12, 28, 0, 0),\n",
       "                          datetime.datetime(2013, 4, 1, 0, 0),\n",
       "                          datetime.datetime(2013, 5, 7, 0, 0),\n",
       "                          datetime.datetime(2013, 5, 9, 0, 0),\n",
       "                          datetime.datetime(2013, 5, 14, 0, 0),\n",
       "                          datetime.datetime(2013, 5, 20, 0, 0),\n",
       "                          datetime.datetime(2013, 5, 29, 0, 0),\n",
       "                          datetime.datetime(2013, 8, 30, 0, 0),\n",
       "                          datetime.datetime(2013, 10, 8, 0, 0),\n",
       "                          datetime.datetime(2014, 1, 2, 0, 0),\n",
       "                          datetime.datetime(2014, 1, 24, 0, 0),\n",
       "                          datetime.datetime(2014, 4, 4, 0, 0),\n",
       "                          datetime.datetime(2014, 4, 10, 0, 0),\n",
       "                          datetime.datetime(2014, 7, 8, 0, 0),\n",
       "                          datetime.datetime(2014, 7, 15, 0, 0),\n",
       "                          datetime.datetime(2014, 8, 25, 0, 0),\n",
       "                          datetime.datetime(2014, 10, 9, 0, 0),\n",
       "                          datetime.datetime(2014, 12, 10, 0, 0),\n",
       "                          datetime.datetime(2014, 12, 31, 0, 0),\n",
       "                          datetime.datetime(2015, 1, 12, 0, 0),\n",
       "                          datetime.datetime(2015, 1, 30, 0, 0),\n",
       "                          datetime.datetime(2015, 6, 8, 0, 0),\n",
       "                          datetime.datetime(2016, 1, 4, 0, 0),\n",
       "                          datetime.datetime(2016, 3, 8, 0, 0),\n",
       "                          datetime.datetime(2016, 4, 4, 0, 0),\n",
       "                          datetime.datetime(2016, 10, 3, 0, 0),\n",
       "                          datetime.datetime(2016, 10, 7, 0, 0),\n",
       "                          datetime.datetime(2016, 11, 2, 0, 0),\n",
       "                          datetime.datetime(2016, 11, 11, 0, 0),\n",
       "                          datetime.datetime(2017, 4, 3, 0, 0),\n",
       "                          datetime.datetime(2017, 4, 5, 0, 0),\n",
       "                          datetime.datetime(2017, 4, 13, 0, 0),\n",
       "                          datetime.datetime(2017, 5, 17, 0, 0),\n",
       "                          datetime.datetime(2017, 7, 3, 0, 0),\n",
       "                          datetime.datetime(2017, 7, 6, 0, 0),\n",
       "                          datetime.datetime(2017, 8, 10, 0, 0),\n",
       "                          datetime.datetime(2017, 9, 5, 0, 0),\n",
       "                          datetime.datetime(2017, 10, 3, 0, 0),\n",
       "                          datetime.datetime(2017, 10, 6, 0, 0),\n",
       "                          datetime.datetime(2018, 1, 25, 0, 0),\n",
       "                          datetime.datetime(2018, 1, 29, 0, 0),\n",
       "                          datetime.datetime(2018, 4, 6, 0, 0),\n",
       "                          datetime.datetime(2018, 7, 3, 0, 0),\n",
       "                          datetime.datetime(2018, 10, 4, 0, 0),\n",
       "                          datetime.datetime(2019, 5, 30, 0, 0),\n",
       "                          datetime.datetime(2019, 8, 1, 0, 0),\n",
       "                          datetime.datetime(2019, 9, 9, 0, 0),\n",
       "                          datetime.datetime(2019, 9, 20, 0, 0),\n",
       "                          datetime.datetime(2019, 9, 24, 0, 0),\n",
       "                          datetime.datetime(2020, 1, 3, 0, 0),\n",
       "                          datetime.datetime(2020, 1, 24, 0, 0),\n",
       "                          datetime.datetime(2020, 2, 13, 0, 0),\n",
       "                          datetime.datetime(2020, 7, 13, 0, 0),\n",
       "                          datetime.datetime(2020, 9, 3, 0, 0),\n",
       "                          datetime.datetime(2020, 10, 14, 0, 0),\n",
       "                          datetime.datetime(2021, 1, 4, 0, 0),\n",
       "                          datetime.datetime(2021, 1, 11, 0, 0),\n",
       "                          datetime.datetime(2021, 1, 27, 0, 0),\n",
       "                          datetime.datetime(2021, 1, 29, 0, 0),\n",
       "                          datetime.datetime(2021, 3, 9, 0, 0),\n",
       "                          datetime.datetime(2021, 5, 20, 0, 0),\n",
       "                          datetime.datetime(2021, 7, 6, 0, 0),\n",
       "                          datetime.datetime(2021, 8, 16, 0, 0),\n",
       "                          datetime.datetime(2021, 9, 29, 0, 0),\n",
       "                          datetime.datetime(2021, 11, 26, 0, 0),\n",
       "                          datetime.datetime(2022, 1, 5, 0, 0),\n",
       "                          datetime.datetime(2022, 4, 5, 0, 0),\n",
       "                          datetime.datetime(2022, 9, 23, 0, 0),\n",
       "                          datetime.datetime(2022, 10, 10, 0, 0),\n",
       "                          datetime.datetime(2023, 1, 3, 0, 0),\n",
       "                          datetime.datetime(2023, 1, 9, 0, 0),\n",
       "                          datetime.datetime(2023, 3, 10, 0, 0),\n",
       "                          datetime.datetime(2023, 4, 4, 0, 0),\n",
       "                          datetime.datetime(2023, 4, 10, 0, 0),\n",
       "                          datetime.datetime(2023, 4, 25, 0, 0),\n",
       "                          datetime.datetime(2023, 5, 24, 0, 0),\n",
       "                          datetime.datetime(2023, 7, 4, 0, 0),\n",
       "                          datetime.datetime(2023, 8, 3, 0, 0),\n",
       "                          datetime.datetime(2023, 8, 15, 0, 0),\n",
       "                          datetime.datetime(2023, 9, 21, 0, 0),\n",
       "                          datetime.datetime(2023, 10, 13, 0, 0),\n",
       "                          datetime.datetime(2024, 1, 2, 0, 0),\n",
       "                          datetime.datetime(2024, 2, 1, 0, 0),\n",
       "                          datetime.datetime(2024, 2, 5, 0, 0),\n",
       "                          datetime.datetime(2024, 2, 8, 0, 0),\n",
       "                          datetime.datetime(2024, 2, 13, 0, 0),\n",
       "                          datetime.datetime(2024, 4, 1, 0, 0),\n",
       "                          datetime.datetime(2024, 4, 11, 0, 0),\n",
       "                          datetime.datetime(2024, 6, 3, 0, 0),\n",
       "                          datetime.datetime(2024, 7, 5, 0, 0),\n",
       "                          datetime.datetime(2024, 7, 9, 0, 0),\n",
       "                          datetime.datetime(2024, 10, 1, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 2, 0, 0)], dtype=object),\n",
       "              'xaxis': 'x2',\n",
       "              'y': array([7.20045695e-04, 1.25989839e-02, 2.10200030e-04, 1.45285244e-03,\n",
       "                          9.59404371e-04, 5.10210948e-04, 7.18623675e-05, 2.08293450e-04,\n",
       "                          4.82773001e-03, 3.62503212e-03, 1.52624197e-04, 3.86172356e-05,\n",
       "                          5.45712963e-03, 1.54435226e-03, 5.01125148e-05, 6.86029500e-05,\n",
       "                          6.33390916e-05, 4.25786451e-05, 7.71553093e-04, 1.01334859e-03,\n",
       "                          3.30064380e-04, 1.22425582e-03, 9.68910608e-04, 3.39757050e-04,\n",
       "                          3.18932297e-03, 3.60239004e-04, 2.47950443e-03, 5.05430982e-05,\n",
       "                          7.92880444e-05, 1.73508442e-04, 7.66730700e-03, 1.75214478e-04,\n",
       "                          2.58698566e-03, 6.46437888e-03, 3.31479088e-03, 9.40847407e-04,\n",
       "                          7.70409578e-02, 3.38177057e-02, 1.03357239e-02, 8.92996054e-04,\n",
       "                          1.56009991e-02, 2.15247998e-05, 6.23142505e-03, 1.67380429e-02,\n",
       "                          3.16214496e-03, 2.90866914e-03, 1.69009202e-03, 2.79677370e-03,\n",
       "                          2.89828992e-02, 4.59438704e-03, 3.26560817e-04, 2.10675892e-03,\n",
       "                          1.29865152e-02, 7.08981707e-04, 1.76036400e-03, 1.70303163e-03,\n",
       "                          7.93754498e-04, 7.55458900e-04, 1.29374410e-03, 1.16945400e-02,\n",
       "                          6.99615101e-04, 1.48867514e-04, 6.96878832e-04, 1.08526944e-04,\n",
       "                          1.88880214e-04, 2.09743382e-03, 1.16864991e-04, 8.44731006e-03,\n",
       "                          2.22717401e-03, 6.19464493e-03, 2.64884533e-04, 5.64693645e-03,\n",
       "                          4.24815095e-05, 5.87081254e-04, 3.59628474e-04, 1.54243102e-03,\n",
       "                          3.83555835e-04, 1.68034989e-04, 1.28836538e-04, 9.12054143e-03,\n",
       "                          7.67571678e-04, 5.28192807e-03, 1.14618130e-02, 1.86305087e-02,\n",
       "                          2.26278092e-04, 2.13800655e-03, 3.80507848e-04, 2.03396611e-02,\n",
       "                          4.20519600e-04, 6.27228963e-04, 6.23662509e-04, 4.34783867e-03,\n",
       "                          7.66781084e-05, 2.47025230e-03, 2.49210716e-04, 2.41274263e-03,\n",
       "                          2.71887201e-04, 1.42970905e-02, 1.77108575e-04, 3.18862106e-05,\n",
       "                          3.57440341e-04, 5.24806581e-03, 2.29108558e-02, 1.35105862e-02,\n",
       "                          2.81450722e-04, 2.37949456e-03, 3.66920267e-04, 1.46510535e-02,\n",
       "                          2.09707455e-03, 8.11604539e-05, 6.47224465e-02, 1.60647449e-02,\n",
       "                          7.27813558e-04, 1.98690806e-02, 2.48947544e-03, 2.24607965e-04,\n",
       "                          4.03947659e-04, 1.93318817e-03, 4.53730460e-04, 4.15334240e-03,\n",
       "                          1.77250526e-04, 4.99529668e-04, 2.37875532e-03, 2.40019544e-03,\n",
       "                          6.50215918e-04, 5.14682435e-03, 1.87327614e-03, 9.40881459e-03,\n",
       "                          3.56927401e-04, 8.55338173e-03, 3.47523990e-03, 1.48757050e-03,\n",
       "                          1.29589406e-03, 1.53638863e-03, 6.04330561e-03, 4.04476853e-03,\n",
       "                          1.75845861e-04, 1.51606694e-03, 4.01038643e-04, 1.48534124e-02,\n",
       "                          2.26904134e-03, 3.93041131e-04, 4.76955660e-04, 2.91933994e-04,\n",
       "                          2.35073504e-03, 5.51020106e-04, 2.97878238e-04, 2.58993211e-04,\n",
       "                          1.89843263e-04, 3.00168822e-03, 1.26576635e-02]),\n",
       "              'yaxis': 'y2'},\n",
       "             {'customdata': array([[ 2.00000000e+00,  2.00000000e+00, -9.67076729e+00, -9.54356962e-05],\n",
       "                                   [ 6.00000000e+00,  6.00000000e+00, -4.24240771e+01, -4.17604832e-04],\n",
       "                                   [ 7.00000000e+00,  7.00000000e+00, -6.45539861e+01, -6.35707854e-04],\n",
       "                                   ...,\n",
       "                                   [ 2.14000000e+02,  2.14000000e+02, -8.00647158e+01, -4.39657531e-04],\n",
       "                                   [ 2.17000000e+02,  2.17000000e+02, -1.13455516e+01, -6.13656911e-05],\n",
       "                                   [ 2.18000000e+02,  2.18000000e+02, -6.40918704e+01, -3.46680659e-04]]),\n",
       "              'hovertemplate': ('Exit Trade Id: %{customdata[0]' ... 'r>Return: %{customdata[3]:.2%}'),\n",
       "              'legendgroup': '4',\n",
       "              'marker': {'color': '#EA4335',\n",
       "                         'line': {'color': 'rgb(181,31,18)', 'width': 1},\n",
       "                         'opacity': array([0.75018581, 0.75081308, 0.75123773, 0.75002972, 0.75082304, 0.75069209,\n",
       "                                           0.75042756, 0.75033145, 0.75010061, 0.75109271, 0.7537095 , 0.75021817,\n",
       "                                           0.7501669 , 0.75058217, 0.75013751, 0.75100143, 0.75000718, 0.76018729,\n",
       "                                           0.75069103, 0.75400309, 0.75488727, 0.75133608, 0.75058503, 0.75013708,\n",
       "                                           0.75017426, 0.77676887, 0.75033505, 0.75513283, 0.75286813, 0.75074895,\n",
       "                                           0.75244656, 0.7505394 , 0.75340094, 0.75081195, 0.75098741, 0.75094648,\n",
       "                                           0.75076702, 0.75070301, 0.75071589, 0.75010076, 0.75069462, 0.75022333,\n",
       "                                           0.75080288, 0.75181282, 0.75448545, 0.75209018, 0.76161127, 0.75040463,\n",
       "                                           0.75114121, 0.75002199, 0.7611089 , 0.75001028, 0.75229163, 0.75005025,\n",
       "                                           0.75161839, 0.75152163, 0.75083958, 0.75250289, 0.75048425, 0.75078199,\n",
       "                                           0.75024192, 0.75130449, 0.75237333, 0.75024472, 0.75085602, 0.75011948,\n",
       "                                           0.75067499]),\n",
       "                         'size': array([7.00867136, 7.03794389, 7.0577609 , 7.00138684, 7.03840853, 7.03229731,\n",
       "                                        7.01995296, 7.01546744, 7.00469505, 7.05099324, 7.17311021, 7.0101814 ,\n",
       "                                        7.00778847, 7.02716815, 7.00641723, 7.04673363, 7.00033519, 7.47540708,\n",
       "                                        7.03224786, 7.18681082, 7.22807242, 7.06235022, 7.02730138, 7.00639717,\n",
       "                                        7.0081323 , 8.24921397, 7.01563557, 7.23953193, 7.13384608, 7.0349512 ,\n",
       "                                        7.11417288, 7.02517194, 7.15871064, 7.03789095, 7.04607927, 7.04416901,\n",
       "                                        7.03579413, 7.03280722, 7.03340812, 7.00470227, 7.03241582, 7.01042209,\n",
       "                                        7.03746792, 7.08459824, 7.20932093, 7.09754158, 7.54185942, 7.01888263,\n",
       "                                        7.0532567 , 7.00102608, 7.51841535, 7.0004798 , 7.10694288, 7.002345  ,\n",
       "                                        7.07552503, 7.07100958, 7.03918033, 7.1168016 , 7.02259855, 7.0364927 ,\n",
       "                                        7.01128968, 7.06087629, 7.11075535, 7.01142009, 7.03994762, 7.00557573,\n",
       "                                        7.03149967]),\n",
       "                         'symbol': 'circle'},\n",
       "              'mode': 'markers',\n",
       "              'name': 'Closed - Loss',\n",
       "              'type': 'scatter',\n",
       "              'uid': '5e3a54d3-b0d8-44aa-9603-933cde4fcf36',\n",
       "              'x': array([datetime.datetime(2004, 3, 15, 0, 0),\n",
       "                          datetime.datetime(2004, 5, 6, 0, 0),\n",
       "                          datetime.datetime(2004, 6, 3, 0, 0),\n",
       "                          datetime.datetime(2004, 7, 21, 0, 0),\n",
       "                          datetime.datetime(2004, 9, 20, 0, 0),\n",
       "                          datetime.datetime(2004, 9, 22, 0, 0),\n",
       "                          datetime.datetime(2004, 9, 27, 0, 0),\n",
       "                          datetime.datetime(2004, 10, 20, 0, 0),\n",
       "                          datetime.datetime(2004, 11, 1, 0, 0),\n",
       "                          datetime.datetime(2005, 1, 20, 0, 0),\n",
       "                          datetime.datetime(2005, 4, 14, 0, 0),\n",
       "                          datetime.datetime(2005, 5, 10, 0, 0),\n",
       "                          datetime.datetime(2005, 9, 13, 0, 0),\n",
       "                          datetime.datetime(2005, 11, 30, 0, 0),\n",
       "                          datetime.datetime(2005, 12, 7, 0, 0),\n",
       "                          datetime.datetime(2006, 4, 3, 0, 0),\n",
       "                          datetime.datetime(2007, 3, 13, 0, 0),\n",
       "                          datetime.datetime(2007, 6, 6, 0, 0),\n",
       "                          datetime.datetime(2007, 6, 22, 0, 0),\n",
       "                          datetime.datetime(2007, 7, 10, 0, 0),\n",
       "                          datetime.datetime(2007, 7, 20, 0, 0),\n",
       "                          datetime.datetime(2007, 10, 11, 0, 0),\n",
       "                          datetime.datetime(2007, 10, 15, 0, 0),\n",
       "                          datetime.datetime(2008, 1, 4, 0, 0),\n",
       "                          datetime.datetime(2008, 7, 9, 0, 0),\n",
       "                          datetime.datetime(2008, 9, 4, 0, 0),\n",
       "                          datetime.datetime(2009, 2, 10, 0, 0),\n",
       "                          datetime.datetime(2010, 4, 27, 0, 0),\n",
       "                          datetime.datetime(2011, 5, 23, 0, 0),\n",
       "                          datetime.datetime(2011, 6, 1, 0, 0),\n",
       "                          datetime.datetime(2011, 7, 26, 0, 0),\n",
       "                          datetime.datetime(2012, 7, 23, 0, 0),\n",
       "                          datetime.datetime(2012, 10, 23, 0, 0),\n",
       "                          datetime.datetime(2013, 4, 15, 0, 0),\n",
       "                          datetime.datetime(2013, 10, 2, 0, 0),\n",
       "                          datetime.datetime(2014, 7, 18, 0, 0),\n",
       "                          datetime.datetime(2014, 7, 28, 0, 0),\n",
       "                          datetime.datetime(2014, 8, 5, 0, 0),\n",
       "                          datetime.datetime(2014, 9, 22, 0, 0),\n",
       "                          datetime.datetime(2014, 10, 7, 0, 0),\n",
       "                          datetime.datetime(2014, 10, 22, 0, 0),\n",
       "                          datetime.datetime(2015, 1, 5, 0, 0),\n",
       "                          datetime.datetime(2015, 1, 28, 0, 0),\n",
       "                          datetime.datetime(2015, 6, 15, 0, 0),\n",
       "                          datetime.datetime(2015, 6, 29, 0, 0),\n",
       "                          datetime.datetime(2015, 7, 8, 0, 0),\n",
       "                          datetime.datetime(2015, 8, 20, 0, 0),\n",
       "                          datetime.datetime(2016, 10, 21, 0, 0),\n",
       "                          datetime.datetime(2019, 1, 3, 0, 0),\n",
       "                          datetime.datetime(2020, 2, 18, 0, 0),\n",
       "                          datetime.datetime(2020, 10, 1, 0, 0),\n",
       "                          datetime.datetime(2021, 5, 4, 0, 0),\n",
       "                          datetime.datetime(2021, 5, 13, 0, 0),\n",
       "                          datetime.datetime(2021, 7, 14, 0, 0),\n",
       "                          datetime.datetime(2021, 11, 30, 0, 0),\n",
       "                          datetime.datetime(2022, 4, 21, 0, 0),\n",
       "                          datetime.datetime(2023, 3, 22, 0, 0),\n",
       "                          datetime.datetime(2023, 5, 4, 0, 0),\n",
       "                          datetime.datetime(2023, 9, 7, 0, 0),\n",
       "                          datetime.datetime(2023, 10, 17, 0, 0),\n",
       "                          datetime.datetime(2024, 1, 12, 0, 0),\n",
       "                          datetime.datetime(2024, 5, 29, 0, 0),\n",
       "                          datetime.datetime(2024, 6, 20, 0, 0),\n",
       "                          datetime.datetime(2024, 7, 22, 0, 0),\n",
       "                          datetime.datetime(2024, 8, 1, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 7, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 27, 0, 0)], dtype=object),\n",
       "              'xaxis': 'x2',\n",
       "              'y': array([-9.54356962e-05, -4.17604832e-04, -6.35707854e-04, -1.52633231e-05,\n",
       "                          -4.22718562e-04, -3.55459394e-04, -2.19599283e-04, -1.70232291e-04,\n",
       "                          -5.16729671e-05, -5.61223999e-04, -1.90522522e-03, -1.12054919e-04,\n",
       "                          -8.57187834e-05, -2.99008562e-04, -7.06271323e-05, -5.14343351e-04,\n",
       "                          -3.68904770e-06, -5.23225957e-03, -3.54915171e-04, -2.05601206e-03,\n",
       "                          -2.51013115e-03, -6.86217201e-04, -3.00474903e-04, -7.04062597e-05,\n",
       "                          -8.95028777e-05, -1.37486629e-02, -1.72082740e-04, -2.63625277e-03,\n",
       "                          -1.47309000e-03, -3.84667757e-04, -1.25656975e-03, -2.77038623e-04,\n",
       "                          -1.74674567e-03, -4.17022203e-04, -5.07141562e-04, -4.86117532e-04,\n",
       "                          -3.93944855e-04, -3.61071358e-04, -3.67684830e-04, -5.17524443e-05,\n",
       "                          -3.56763689e-04, -1.14704021e-04, -4.12366351e-04, -9.31075629e-04,\n",
       "                          -2.30375500e-03, -1.07352812e-03, -5.96362413e-03, -2.07819362e-04,\n",
       "                          -5.86135291e-04, -1.12928850e-05, -5.70560216e-03, -5.28059404e-06,\n",
       "                          -1.17699742e-03, -2.58087506e-05, -8.31217219e-04, -7.81520915e-04,\n",
       "                          -4.31212855e-04, -1.28550098e-03, -2.48716323e-04, -4.01633174e-04,\n",
       "                          -1.24252511e-04, -6.69995422e-04, -1.21895694e-03, -1.25687775e-04,\n",
       "                          -4.39657531e-04, -6.13656911e-05, -3.46680659e-04]),\n",
       "              'yaxis': 'y2'},\n",
       "             {'customdata': array([[ 2.19000000e+02,  2.19000000e+02, -5.44617764e+01, -2.94692483e-04]]),\n",
       "              'hovertemplate': ('Exit Trade Id: %{customdata[0]' ... 'r>Return: %{customdata[3]:.2%}'),\n",
       "              'legendgroup': '5',\n",
       "              'marker': {'color': '#FFAA00',\n",
       "                         'line': {'color': 'rgb(178,118,0)', 'width': 1},\n",
       "                         'opacity': array([0.75057377]),\n",
       "                         'size': array([7.02677598]),\n",
       "                         'symbol': 'circle'},\n",
       "              'mode': 'markers',\n",
       "              'name': 'Open',\n",
       "              'type': 'scatter',\n",
       "              'uid': '0ebe31f3-3477-4da6-a08e-7d15c34704da',\n",
       "              'x': array([datetime.datetime(2025, 1, 31, 0, 0)], dtype=object),\n",
       "              'xaxis': 'x2',\n",
       "              'y': array([-0.00029469]),\n",
       "              'yaxis': 'y2'},\n",
       "             {'legendgroup': '6',\n",
       "              'line': {'color': '#7f7f7f'},\n",
       "              'name': 'Benchmark',\n",
       "              'showlegend': True,\n",
       "              'type': 'scatter',\n",
       "              'uid': '4d8fc788-54a9-4a8a-8e38-adb2fa289068',\n",
       "              'x': array([datetime.datetime(2003, 9, 24, 0, 0),\n",
       "                          datetime.datetime(2003, 9, 25, 0, 0),\n",
       "                          datetime.datetime(2003, 9, 26, 0, 0), ...,\n",
       "                          datetime.datetime(2025, 1, 29, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 30, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 31, 0, 0)], dtype=object),\n",
       "              'xaxis': 'x3',\n",
       "              'y': array([1.        , 0.99812819, 0.99975901, ..., 1.31834161, 1.31830358,\n",
       "                          1.31830358]),\n",
       "              'yaxis': 'y3'},\n",
       "             {'hoverinfo': 'skip',\n",
       "              'legendgroup': '7',\n",
       "              'line': {'color': 'rgba(0, 0, 0, 0)', 'width': 0},\n",
       "              'opacity': 0,\n",
       "              'showlegend': False,\n",
       "              'type': 'scatter',\n",
       "              'uid': '33641ec8-5e17-424d-b3f5-aea276e2305e',\n",
       "              'x': array([datetime.datetime(2003, 9, 24, 0, 0),\n",
       "                          datetime.datetime(2003, 9, 25, 0, 0),\n",
       "                          datetime.datetime(2003, 9, 26, 0, 0), ...,\n",
       "                          datetime.datetime(2025, 1, 29, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 30, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 31, 0, 0)], dtype=object),\n",
       "              'xaxis': 'x3',\n",
       "              'y': array([1, 1, 1, ..., 1, 1, 1]),\n",
       "              'yaxis': 'y3'},\n",
       "             {'connectgaps': False,\n",
       "              'fill': 'tonexty',\n",
       "              'fillcolor': 'rgba(0, 128, 0, 0.3)',\n",
       "              'hoverinfo': 'skip',\n",
       "              'legendgroup': '7',\n",
       "              'line': {'color': 'rgba(0, 0, 0, 0)', 'width': 0},\n",
       "              'opacity': 0,\n",
       "              'showlegend': False,\n",
       "              'type': 'scatter',\n",
       "              'uid': '97abbe4e-ef7e-476a-921c-8d9fbf9e8670',\n",
       "              'x': array([datetime.datetime(2003, 9, 24, 0, 0),\n",
       "                          datetime.datetime(2003, 9, 25, 0, 0),\n",
       "                          datetime.datetime(2003, 9, 26, 0, 0), ...,\n",
       "                          datetime.datetime(2025, 1, 29, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 30, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 31, 0, 0)], dtype=object),\n",
       "              'xaxis': 'x3',\n",
       "              'y': array([1.        , 1.        , 1.        , ..., 1.84759709, 1.8475438 ,\n",
       "                          1.8475438 ]),\n",
       "              'yaxis': 'y3'},\n",
       "             {'hoverinfo': 'skip',\n",
       "              'legendgroup': '7',\n",
       "              'line': {'color': 'rgba(0, 0, 0, 0)', 'width': 0},\n",
       "              'opacity': 0,\n",
       "              'showlegend': False,\n",
       "              'type': 'scatter',\n",
       "              'uid': '4ccb29de-993e-4ba7-9b3e-8586b4686a7b',\n",
       "              'x': array([datetime.datetime(2003, 9, 24, 0, 0),\n",
       "                          datetime.datetime(2003, 9, 25, 0, 0),\n",
       "                          datetime.datetime(2003, 9, 26, 0, 0), ...,\n",
       "                          datetime.datetime(2025, 1, 29, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 30, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 31, 0, 0)], dtype=object),\n",
       "              'xaxis': 'x3',\n",
       "              'y': array([1, 1, 1, ..., 1, 1, 1]),\n",
       "              'yaxis': 'y3'},\n",
       "             {'connectgaps': False,\n",
       "              'fill': 'tonexty',\n",
       "              'fillcolor': 'rgba(255, 0, 0, 0.3)',\n",
       "              'hoverinfo': 'skip',\n",
       "              'legendgroup': '7',\n",
       "              'line': {'color': 'rgba(0, 0, 0, 0)', 'width': 0},\n",
       "              'opacity': 0,\n",
       "              'showlegend': False,\n",
       "              'type': 'scatter',\n",
       "              'uid': '26bf8f88-9084-4676-b7d6-6a028f38de66',\n",
       "              'x': array([datetime.datetime(2003, 9, 24, 0, 0),\n",
       "                          datetime.datetime(2003, 9, 25, 0, 0),\n",
       "                          datetime.datetime(2003, 9, 26, 0, 0), ...,\n",
       "                          datetime.datetime(2025, 1, 29, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 30, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 31, 0, 0)], dtype=object),\n",
       "              'xaxis': 'x3',\n",
       "              'y': array([1.        , 0.99812819, 0.99975901, ..., 1.        , 1.        ,\n",
       "                          1.        ]),\n",
       "              'yaxis': 'y3'},\n",
       "             {'legendgroup': '8',\n",
       "              'line': {'color': '#9467bd'},\n",
       "              'name': 'Value',\n",
       "              'showlegend': True,\n",
       "              'type': 'scatter',\n",
       "              'uid': '6db21a63-16f1-4524-9e9d-d7710055f413',\n",
       "              'x': array([datetime.datetime(2003, 9, 24, 0, 0),\n",
       "                          datetime.datetime(2003, 9, 25, 0, 0),\n",
       "                          datetime.datetime(2003, 9, 26, 0, 0), ...,\n",
       "                          datetime.datetime(2025, 1, 29, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 30, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 31, 0, 0)], dtype=object),\n",
       "              'xaxis': 'x3',\n",
       "              'y': array([1.        , 0.99812819, 0.99975901, ..., 1.84759709, 1.8475438 ,\n",
       "                          1.8475438 ]),\n",
       "              'yaxis': 'y3'},\n",
       "             {'hoverinfo': 'skip',\n",
       "              'legendgroup': '7',\n",
       "              'line': {'color': 'rgba(0, 0, 0, 0)', 'width': 0},\n",
       "              'opacity': 0.0,\n",
       "              'showlegend': False,\n",
       "              'type': 'scatter',\n",
       "              'uid': '92141564-074d-40af-b2b2-add0b0d9823b',\n",
       "              'x': array([datetime.datetime(2003, 9, 24, 0, 0),\n",
       "                          datetime.datetime(2003, 9, 25, 0, 0),\n",
       "                          datetime.datetime(2003, 9, 26, 0, 0), ...,\n",
       "                          datetime.datetime(2025, 1, 29, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 30, 0, 0),\n",
       "                          datetime.datetime(2025, 1, 31, 0, 0)], dtype=object),\n",
       "              'xaxis': 'x3',\n",
       "              'y': array([1, 1, 1, ..., 1, 1, 1]),\n",
       "              'yaxis': 'y3'}],\n",
       "    'layout': {'annotations': [{'font': {'size': 16},\n",
       "                                'showarrow': False,\n",
       "                                'text': 'Orders',\n",
       "                                'x': 0.5,\n",
       "                                'xanchor': 'center',\n",
       "                                'xref': 'paper',\n",
       "                                'y': 1.0,\n",
       "                                'yanchor': 'bottom',\n",
       "                                'yref': 'paper'},\n",
       "                               {'font': {'size': 16},\n",
       "                                'showarrow': False,\n",
       "                                'text': 'Trade PnL',\n",
       "                                'x': 0.5,\n",
       "                                'xanchor': 'center',\n",
       "                                'xref': 'paper',\n",
       "                                'y': 0.6527777777777777,\n",
       "                                'yanchor': 'bottom',\n",
       "                                'yref': 'paper'},\n",
       "                               {'font': {'size': 16},\n",
       "                                'showarrow': False,\n",
       "                                'text': 'Cumulative Returns',\n",
       "                                'x': 0.5,\n",
       "                                'xanchor': 'center',\n",
       "                                'xref': 'paper',\n",
       "                                'y': 0.3055555555555555,\n",
       "                                'yanchor': 'bottom',\n",
       "                                'yref': 'paper'}],\n",
       "               'height': 960,\n",
       "               'legend': {'orientation': 'h',\n",
       "                          'traceorder': 'normal',\n",
       "                          'x': 1,\n",
       "                          'xanchor': 'right',\n",
       "                          'y': 1.0416666666666667,\n",
       "                          'yanchor': 'bottom'},\n",
       "               'margin': {'b': 30, 'l': 30, 'r': 30, 't': 30},\n",
       "               'shapes': [{'line': {'color': 'gray', 'dash': 'dash'},\n",
       "                           'type': 'line',\n",
       "                           'x0': 0.0,\n",
       "                           'x1': 1.0,\n",
       "                           'xref': 'paper',\n",
       "                           'y0': 0,\n",
       "                           'y1': 0,\n",
       "                           'yref': 'y2'},\n",
       "                          {'line': {'color': 'gray', 'dash': 'dash'},\n",
       "                           'type': 'line',\n",
       "                           'x0': 0.0,\n",
       "                           'x1': 1.0,\n",
       "                           'xref': 'paper',\n",
       "                           'y0': 1,\n",
       "                           'y1': 1,\n",
       "                           'yref': 'y3'}],\n",
       "               'showlegend': True,\n",
       "               'template': '...',\n",
       "               'width': 750,\n",
       "               'xaxis': {'anchor': 'y', 'domain': [0.0, 1.0], 'matches': 'x3', 'showticklabels': False},\n",
       "               'xaxis2': {'anchor': 'y2', 'domain': [0.0, 1.0], 'matches': 'x3', 'showticklabels': False},\n",
       "               'xaxis3': {'anchor': 'y3', 'domain': [0.0, 1.0], 'title': {'text': 'Index'}},\n",
       "               'yaxis': {'anchor': 'x', 'domain': [0.6944444444444444, 1.0], 'title': {'text': 'Price'}},\n",
       "               'yaxis2': {'anchor': 'x2',\n",
       "                          'domain': [0.3472222222222222, 0.6527777777777777],\n",
       "                          'tickformat': '.2%',\n",
       "                          'title': {'text': 'Trade PnL'}},\n",
       "               'yaxis3': {'anchor': 'x3', 'domain': [0.0, 0.3055555555555555], 'title': {'text': 'Cumulative returns'}}}\n",
       "})"
      ]
     },
     "execution_count": 12,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# Get second best strategy name\n",
    "second_best_strategy = results_df.iloc[1]['Strategy']\n",
    "second_best_portfolio = all_portfolios[second_best_strategy]\n",
    "\n",
    "# Plot the second best portfolio\n",
    "second_best_portfolio.plot()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "Second Best Strategy: Combined:us_hy_er_index_1yr_<lambda>:cad_oas_ytd_<lambda>:cad_ig_er_index_ytd_<lambda>:cad_ig_er_index_qtd_<lambda>:vix_qtd_<lambda>:cad_ig_er_index_1yr_<lambda>:us_hy_er_index_3m_<lambda>:us_ig_er_index_3m_<lambda>:tsx_qtd_<lambda>:us_ig_oas_ytd_<lambda>:cad_oas_qtd_<lambda>:AND:AND:OR:OR:OR:AND:AND:AND:AND:OR\n",
      "\n",
      "Second Best Strategy Performance:\n",
      "Total Return: 84.75%\n",
      "Sharpe Ratio: 3.65\n",
      "Max Drawdown: -1.76%\n"
     ]
    }
   ],
   "source": [
    "print(\"\\nSecond Best Strategy:\", second_best_strategy)\n",
    "print(\"\\nSecond Best Strategy Performance:\")\n",
    "print(f\"Total Return: {second_best_portfolio.total_return():.2%}\")\n",
    "print(f\"Sharpe Ratio: {second_best_portfolio.sharpe_ratio():.2f}\")\n",
    "print(f\"Max Drawdown: {second_best_portfolio.max_drawdown():.2%}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Top 3 Strategies Analysis:\n",
      "--------------------------------------------------\n",
      "\n",
      "Strategy #42\n",
      "Performance:\n",
      "Total Return: 85.61%\n",
      "Sharpe Ratio: 3.31\n",
      "Max Drawdown: -3.07%\n",
      "\n",
      "Signals Used:\n",
      "- us_ig_oas_qtd_<lambda>\n",
      "- tsx_3m_<lambda>\n",
      "\n",
      "Logical Operations:\n",
      "- OR\n",
      "--------------------------------------------------\n",
      "\n",
      "Strategy #29\n",
      "Performance:\n",
      "Total Return: 84.75%\n",
      "Sharpe Ratio: 3.65\n",
      "Max Drawdown: -1.76%\n",
      "\n",
      "Signals Used:\n",
      "- us_hy_er_index_1yr_<lambda>\n",
      "- cad_oas_ytd_<lambda>\n",
      "- cad_ig_er_index_ytd_<lambda>\n",
      "- cad_ig_er_index_qtd_<lambda>\n",
      "- vix_qtd_<lambda>\n",
      "- cad_ig_er_index_1yr_<lambda>\n",
      "- us_hy_er_index_3m_<lambda>\n",
      "- us_ig_er_index_3m_<lambda>\n",
      "- tsx_qtd_<lambda>\n",
      "- us_ig_oas_ytd_<lambda>\n",
      "- cad_oas_qtd_<lambda>\n",
      "- AND\n",
      "- AND\n",
      "- OR\n",
      "- OR\n",
      "- OR\n",
      "- AND\n",
      "- AND\n",
      "- AND\n",
      "- AND\n",
      "\n",
      "Logical Operations:\n",
      "- OR\n",
      "--------------------------------------------------\n",
      "\n",
      "Strategy #17\n",
      "Performance:\n",
      "Total Return: 84.23%\n",
      "Sharpe Ratio: 3.33\n",
      "Max Drawdown: -1.84%\n",
      "\n",
      "Signals Used:\n",
      "- us_hy_er_index_qtd_<lambda>\n",
      "- us_ig_er_index_qtd_<lambda>\n",
      "\n",
      "Logical Operations:\n",
      "- OR\n",
      "--------------------------------------------------\n"
     ]
    }
   ],
   "source": [
    "# Get top 3 strategies\n",
    "top_3_strategies = results_df.head(3)\n",
    "\n",
    "print(\"Top 3 Strategies Analysis:\")\n",
    "print(\"-\" * 50)\n",
    "\n",
    "for idx, row in top_3_strategies.iterrows():\n",
    "    strategy_name = row['Strategy']\n",
    "    \n",
    "    # Split the strategy name into components\n",
    "    # Format is \"Combined:signal1:signal2:...:operations\"\n",
    "    all_components = strategy_name.split(':')\n",
    "    \n",
    "    # Separate signals and operations\n",
    "    # The format will be: ['Combined', signal1, signal2, ..., 'OR:AND:OR']\n",
    "    signals = all_components[1:-1]  # Skip 'Combined' and the last component (operations)\n",
    "    operations_str = all_components[-1]\n",
    "    operations = operations_str.split(':')\n",
    "    \n",
    "    print(f\"\\nStrategy #{idx + 1}\")\n",
    "    print(f\"Performance:\")\n",
    "    print(f\"Total Return: {row['Total_Return_%']:.2f}%\")\n",
    "    print(f\"Sharpe Ratio: {row['Sharpe_Ratio']:.2f}\")\n",
    "    print(f\"Max Drawdown: {row['Max_Drawdown_%']:.2f}%\")\n",
    "    \n",
    "    print(\"\\nSignals Used:\")\n",
    "    for signal in signals:\n",
    "        print(f\"- {signal}\")\n",
    "    \n",
    "    print(\"\\nLogical Operations:\")\n",
    "    for op in operations:\n",
    "        print(f\"- {op}\")\n",
    "    \n",
    "    print(\"-\" * 50)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "🔄 Trading Strategy Analysis - Top 3 vs Buy & Hold\n",
      "================================================================================\n",
      "\n",
      "📊 Buy & Hold Strategy:\n",
      "• Number of Trades: 1\n",
      "• Total Return: 31.83%\n",
      "--------------------------------------------------------------------------------\n",
      "\n",
      "🏆 Strategy #42\n",
      "\n",
      "📈 Performance Metrics:\n",
      "• Number of Trades: 80\n",
      "• Total Return: 85.61%\n",
      "• Sharpe Ratio: 3.31\n",
      "• Max Drawdown: -3.07%\n",
      "\n",
      "📊 Trade Statistics:\n",
      "• Win Rate [%]: 69.62\n",
      "• Best Trade [%]: 16.73\n",
      "• Worst Trade [%]: -1.74\n",
      "• Avg Winning Trade [%]: 1.24\n",
      "• Avg Losing Trade [%]: -0.25\n",
      "\n",
      "📝 Trading Rules:\n",
      "Enter long position when:\n",
      "• us_ig_oas_qtd is negative\n",
      "  OR\n",
      "• tsx_3m is positive\n",
      "--------------------------------------------------------------------------------\n",
      "\n",
      "🏆 Strategy #29\n",
      "\n",
      "📈 Performance Metrics:\n",
      "• Number of Trades: 220\n",
      "• Total Return: 84.75%\n",
      "• Sharpe Ratio: 3.65\n",
      "• Max Drawdown: -1.76%\n",
      "\n",
      "📊 Trade Statistics:\n",
      "• Win Rate [%]: 68.95\n",
      "• Best Trade [%]: 7.70\n",
      "• Worst Trade [%]: -1.37\n",
      "• Avg Winning Trade [%]: 0.46\n",
      "• Avg Losing Trade [%]: -0.10\n",
      "\n",
      "📝 Trading Rules:\n",
      "Enter long position when:\n",
      "• us_hy_er_index_1yr is positive\n",
      "  AND\n",
      "• cad_oas_ytd is negative\n",
      "  AND\n",
      "• cad_ig_er_index_ytd is positive\n",
      "  OR\n",
      "• cad_ig_er_index_qtd is positive\n",
      "  OR\n",
      "• vix_qtd is negative\n",
      "  OR\n",
      "• cad_ig_er_index_1yr is positive\n",
      "  AND\n",
      "• us_hy_er_index_3m is positive\n",
      "  AND\n",
      "• us_ig_er_index_3m is positive\n",
      "  AND\n",
      "• tsx_qtd is positive\n",
      "  AND\n",
      "• us_ig_oas_ytd is negative\n",
      "  OR\n",
      "• cad_oas_qtd is negative\n",
      "--------------------------------------------------------------------------------\n",
      "\n",
      "🏆 Strategy #17\n",
      "\n",
      "📈 Performance Metrics:\n",
      "• Number of Trades: 93\n",
      "• Total Return: 84.23%\n",
      "• Sharpe Ratio: 3.33\n",
      "• Max Drawdown: -1.84%\n",
      "\n",
      "📊 Trade Statistics:\n",
      "• Win Rate [%]: 60.87\n",
      "• Best Trade [%]: 11.69\n",
      "• Worst Trade [%]: -0.97\n",
      "• Avg Winning Trade [%]: 1.17\n",
      "• Avg Losing Trade [%]: -0.12\n",
      "\n",
      "📝 Trading Rules:\n",
      "Enter long position when:\n",
      "• us_hy_er_index_qtd is positive\n",
      "  OR\n",
      "• us_ig_er_index_qtd is positive\n",
      "--------------------------------------------------------------------------------\n"
     ]
    }
   ],
   "source": [
    "# Get top 3 strategies and buy & hold comparison\n",
    "top_3_strategies = results_df.head(3)\n",
    "\n",
    "print(\"\\n🔄 Trading Strategy Analysis - Top 3 vs Buy & Hold\")\n",
    "print(\"=\" * 80)\n",
    "\n",
    "# Buy & Hold analysis\n",
    "bh_pf = vbt.Portfolio.from_holding(\n",
    "    final_df['cad_ig_er_index'],\n",
    "    freq='1D',\n",
    "    init_cash=100000,\n",
    "    size=1.0,\n",
    "    size_type=SizeType.Percent\n",
    ")\n",
    "\n",
    "print(\"\\n📊 Buy & Hold Strategy:\")\n",
    "print(f\"• Number of Trades: {bh_pf.stats()['Total Trades']}\")\n",
    "print(f\"• Total Return: {bh_pf.total_return():.2%}\")\n",
    "print(\"-\" * 80)\n",
    "\n",
    "# Analyze each top strategy\n",
    "for idx, row in top_3_strategies.iterrows():\n",
    "    strategy_name = row['Strategy']\n",
    "    portfolio = all_portfolios[strategy_name]\n",
    "    stats = portfolio.stats()\n",
    "    \n",
    "    print(f\"\\n🏆 Strategy #{idx + 1}\")\n",
    "    \n",
    "    print(\"\\n📈 Performance Metrics:\")\n",
    "    print(f\"• Number of Trades: {stats['Total Trades']}\")\n",
    "    print(f\"• Total Return: {row['Total_Return_%']:.2f}%\")\n",
    "    print(f\"• Sharpe Ratio: {row['Sharpe_Ratio']:.2f}\")\n",
    "    print(f\"• Max Drawdown: {row['Max_Drawdown_%']:.2f}%\")\n",
    "    \n",
    "    print(\"\\n📊 Trade Statistics:\")\n",
    "    for key in ['Win Rate [%]', 'Best Trade [%]', 'Worst Trade [%]', 'Avg Winning Trade [%]', 'Avg Losing Trade [%]']:\n",
    "        if key in stats:\n",
    "            print(f\"• {key}: {stats[key]:.2f}\")\n",
    "    \n",
    "    # Split the strategy name into components\n",
    "    all_components = strategy_name.split(':')\n",
    "    signals = []\n",
    "    operations = []\n",
    "    \n",
    "    # Parse the strategy string\n",
    "    for component in all_components:\n",
    "        if component in ['AND', 'OR']:\n",
    "            operations.append(component)\n",
    "        elif component != 'Combined':\n",
    "            signals.append(component)\n",
    "    \n",
    "    print(\"\\n📝 Trading Rules:\")\n",
    "    print(\"Enter long position when:\")\n",
    "    \n",
    "    # Format trading rules in plain English\n",
    "    for i, signal in enumerate(signals):\n",
    "        # Clean up signal name\n",
    "        signal = signal.replace('_<lambda>', '')\n",
    "        \n",
    "        # Determine if it's a positive or negative indicator\n",
    "        if any(pos in signal for pos in ['er_index', 'tsx']):\n",
    "            condition = \"is positive\"\n",
    "        else:  # OAS or VIX\n",
    "            condition = \"is negative\"\n",
    "        \n",
    "        # Print the condition\n",
    "        print(f\"• {signal} {condition}\")\n",
    "        \n",
    "        # Print the operation if there's more signals\n",
    "        if i < len(operations):\n",
    "            print(f\"  {operations[i]}\")\n",
    "    \n",
    "    print(\"-\" * 80)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Tear sheet has been saved to: c:/Users/Eddy/Documents/backtrader/Outputs/strategy_17_tearsheet_20250131_142758.html\n",
      "\n",
      "Key Metrics for Strategy #17:\n",
      "Sharpe Ratio: 2.77\n",
      "Sortino Ratio: 4.92\n",
      "Max Drawdown: -1.84%\n",
      "Win Rate: 64.75%\n"
     ]
    }
   ],
   "source": [
    "import quantstats as qs\n",
    "import pandas as pd\n",
    "from datetime import datetime\n",
    "\n",
    "# Get Strategy #17 from the results\n",
    "strategy_17_name = results_df.iloc[2]['Strategy']  # Third row since it's Strategy #17\n",
    "strategy_17_portfolio = all_portfolios[strategy_17_name]\n",
    "\n",
    "# Get the returns series from the portfolio\n",
    "returns = strategy_17_portfolio.returns()\n",
    "\n",
    "# Get benchmark returns (buy & hold of cad_ig_er_index)\n",
    "benchmark_returns = bh_pf.returns()\n",
    "\n",
    "# Generate timestamp for the filename\n",
    "timestamp = datetime.now().strftime(\"%Y%m%d_%H%M%S\")\n",
    "output_path = \"c:/Users/Eddy/Documents/backtrader/Outputs\"\n",
    "html_filename = f\"{output_path}/strategy_17_tearsheet_{timestamp}.html\"\n",
    "\n",
    "# Generate and save the tear sheet\n",
    "qs.reports.html(\n",
    "    returns=returns,\n",
    "    benchmark=benchmark_returns,\n",
    "    title='Strategy #17 Analysis',\n",
    "    output=html_filename,\n",
    "    download_filename=html_filename\n",
    ")\n",
    "\n",
    "print(f\"Tear sheet has been saved to: {html_filename}\")\n",
    "\n",
    "# Also display some key metrics\n",
    "print(\"\\nKey Metrics for Strategy #17:\")\n",
    "print(f\"Sharpe Ratio: {qs.stats.sharpe(returns):.2f}\")\n",
    "print(f\"Sortino Ratio: {qs.stats.sortino(returns):.2f}\")\n",
    "print(f\"Max Drawdown: {qs.stats.max_drawdown(returns):.2%}\")\n",
    "print(f\"Win Rate: {qs.stats.win_rate(returns):.2%}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "tajana-0X0hpMbN-py3.11",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.4"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
